# 4. é“¾ä¸‹æœåŠ¡ä¸æ•°æ®æµ

> æœ¬ç« èŠ‚èšç„¦ BFFï¼ˆ`apps/bff`ï¼‰åœ¨å„åœºæ™¯ä¸‹çš„èŒè´£åˆ’åˆ†ã€æ¨¡å— Anchorã€æ ¸å¿ƒä»£ç ä¸æœªæ¥æ‰©å±•ã€‚ç›¸è¾ƒäºæ—©æœŸç‰ˆæœ¬ï¼Œæœ¬è®¾è®¡è¡¥é½ Fullnode äº‹åŠ¡å…œåº•ä¸ BFF å†…éƒ¨æ•°æ®æµï¼Œç¡®ä¿ä¸ã€Š10-åœºæ™¯åŒ–ç«¯åˆ°ç«¯æ•°æ®æµã€‹ä¸€è‡´ã€‚

## 4.1 æ¨¡å—é”šç‚¹ç´¢å¼•
| åŒºåŸŸ | Anchor | å®æ–½çŠ¶æ€ | è¦†ç›–åœºæ™¯ |
|------|--------|----------|----------|
| Nest å…¥å£ | `apps/bff/src/main.ts:6` | âœ… | å…¨éƒ¨ |
| é…ç½®ä¸­å¿ƒ | `apps/bff/src/common/configuration.ts:1` | âœ… | å…¨éƒ¨ |
| Prisma åŸºç¡€è®¾æ–½ | `apps/bff/src/infrastructure/prisma/prisma.service.ts:1` | âœ… | å…¨éƒ¨ |
| `AccountsModule` | `apps/bff/src/modules/accounts/accounts.module.ts:1` | âœ… | R1ã€R2 |
| `AccountsEventListener` | `apps/bff/src/modules/accounts/event-listener.service.ts:15` | âœ… | R1 |
| `AccountsController` | `apps/bff/src/modules/accounts/accounts.controller.ts:24` | âœ… | R1ã€R2 |
| `AccountsService` | `apps/bff/src/modules/accounts/accounts.service.ts:17` | âœ… | R1ã€R2 |
| `MediaModule` | `apps/bff/src/modules/media/media.module.ts:1` | âœ… | O2ï¼ˆé“¾ä¸‹åª’ä½“ï¼‰ |
| `MediaService` | `apps/bff/src/modules/media/media.service.ts:29` | âœ… | O2ï¼ˆä¸Šä¼ ï¼‰ï¼ŒR2ï¼ˆæ ¡éªŒï¼‰ |
| Fullnode å®¢æˆ·ç«¯ | `apps/bff/src/modules/fullnode/fullnode.module.ts`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | R1â€“S1 äº‹åŠ¡å…œåº• |
| è®¢å•ç›‘å¬æ¨¡å— | `apps/bff/src/modules/orders/orders.module.ts:1`ã€`apps/bff/src/modules/orders/orders.controller.ts:1`ã€`apps/bff/src/modules/orders/orders.service.ts:1`ã€`apps/bff/src/modules/orders/orders-event-listener.service.ts:1` | âœ… åˆç‰ˆ | O1ã€O2 |
| ç†èµ”æ¨¡å— | `apps/bff/src/modules/claims/claims.module.ts`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | C1 |
| è´¨æŠ¼ & ä¿¡ç”¨æ¨¡å— | `apps/bff/src/modules/staking/staking.module.ts`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | S1 |

## 4.2 åŸºç¡€è®¾æ–½ä¸è¿è¡Œæ—¶
- **é…ç½®è£…è½½**ï¼š`configuration`ï¼ˆ`apps/bff/src/common/configuration.ts:1-17`ï¼‰ç»Ÿä¸€æš´éœ² `indexerUrl`ã€`nodeApiUrl`ï¼ˆæœªæ¥ Fullnode å®¢æˆ·ç«¯è¯»å–ï¼‰ã€`ingestion.pollingIntervalMs` ç­‰å‚æ•°ã€‚
- **Prisma è¿æ¥**ï¼š`PrismaService`ï¼ˆ`apps/bff/src/infrastructure/prisma/prisma.service.ts:5-26`ï¼‰åœ¨ `onModuleInit` å»ºç«‹è¿æ¥ï¼Œæ‰€æœ‰ä»“å‚¨å±‚ç»Ÿä¸€ä¾èµ–æ­¤æœåŠ¡ã€‚
- **æ•°æ®åº“ Schema**ï¼š`apps/bff/prisma/schema.prisma:10-55` å®šä¹‰ `Account` ä¸ `MediaAsset` è¡¨ï¼Œç¡®ä¿ä¸é“¾ä¸‹å­˜å‚¨ç»“æ„ã€æ—¶é—´çº¿éœ€æ±‚ä¸€è‡´ã€‚

## 4.3 R1 â€” æ³¨å†Œäº‹ä»¶åŒæ­¥
### 4.3.1 ç›‘å¬æµç¨‹
```ts
// apps/bff/src/modules/accounts/event-listener.service.ts:15-45
const REGISTRATION_EVENTS_QUERY = /* GraphQL */ `
  query RegistrationEvents(
    $eventTypes: [String!]
    $limit: Int!
    $cursorVersion: bigint!
    $cursorEventIndex: bigint!
  ) {
    events(
      where: {
        type: { _in: $eventTypes }
        _or: [
          { transaction_version: { _gt: $cursorVersion } }
          {
            transaction_version: { _eq: $cursorVersion }
            event_index: { _gt: $cursorEventIndex }
          }
        ]
      }
      order_by: [{ transaction_version: asc }, { event_index: asc }]
      limit: $limit
    ) {
      transaction_version
      event_index
      type
      data
      transaction_hash
      account_address
      transaction_timestamp
    }
  }
`;
```
```ts
// apps/bff/src/modules/accounts/event-listener.service.ts:94-122
private async pollOnce(): Promise<void> {
  if (this.isPolling) {
    this.logger.warn('Skip poll tick because previous cycle is still running');
    return;
  }
  this.isPolling = true;
  try {
    let hasMore = true;
    while (hasMore) {
      const events = await this.fetchRegistrationEvents();
      if (events.length === 0) {
        hasMore = false;
        break;
      }
      for (const event of events) {
        await this.processEvent(event);
      }
      hasMore = events.length === this.pageSize;
    }
  } catch (error) {
    this.logger.error('Failed to poll registration events', error instanceof Error ? error.stack : error);
  } finally {
    this.isPolling = false;
  }
}
```
- `fetchRegistrationEvents` è°ƒç”¨ Indexer GraphQLï¼Œå‚æ•° `cursorVersion`ã€`cursorEventIndex` å¯¹åº”æ•°æ®æµ 10.2 çš„å¾ªç¯æ¸¸æ ‡ã€‚
- `processEvent` å†…éƒ¨æ˜ å°„ä¸º `AccountUpsertInput`ï¼Œå¹¶è°ƒç”¨ `AccountsRepository.upsertFromEvent`ï¼ˆ`apps/bff/src/modules/accounts/accounts.repository.ts:42-63`ï¼‰ã€‚

### 4.3.2 æ•°æ®è½åœ°
```ts
// apps/bff/src/modules/accounts/accounts.repository.ts:84-111
private mapInputToCreate(input: AccountUpsertInput): Prisma.AccountCreateInput {
  return {
    accountAddress: input.accountAddress,
    role: this.toAccountRole(input.role),
    profileHashAlgo: 'blake3',
    profileHashValue: input.profileHashValue,
    profileUri: input.profileUri ?? null,
    registeredBy: input.registeredBy,
    txnVersion: input.txnVersion,
    eventIndex: input.eventIndex,
    txnHash: input.txnHash,
    chainTimestamp: input.chainTimestamp
  };
}
```
- `Account` è¡¨è”åˆå”¯ä¸€ç´¢å¼•ï¼ˆ`apps/bff/prisma/schema.prisma:29`ï¼‰ä¿è¯äº‹ä»¶å¹‚ç­‰ï¼Œæ¸¸æ ‡åœ¨ Listener å¯åŠ¨æ—¶é€šè¿‡ `getLatestProcessedEvent` æ¢å¤ã€‚

### 4.3.3 API æš´éœ²
- `GET /api/accounts/:address`ï¼ˆ`apps/bff/src/modules/accounts/accounts.controller.ts:28-38`ï¼‰è°ƒç”¨ `AccountsService.getAccountProfile`ã€‚
- `AccountsService` åœ¨ `getAccountProfile` å†…éƒ¨é€šè¿‡ Hasuraï¼ˆ`apps/bff/src/modules/accounts/accounts.service.ts:87-137`ï¼‰è¡¥å……è®¢å•è®¡æ•°ã€‚
- ç»Ÿä¸€é™„åŠ å“åº”å¤´ `x-haigo-trace-id` ä¾¿äºé“¾è·¯è¿½è¸ªã€‚

### 4.3.4 POC ä¸´æ—¶å…œåº•ï¼ˆFullnode by_versionï¼‰
- èƒŒæ™¯ï¼šéƒ¨åˆ† Indexer å®ä¾‹ä¸æš´éœ² `transaction_hash` å­—æ®µï¼Œå¯¼è‡´è½®è¯¢å¤±è´¥ã€‚
- æ–¹æ¡ˆï¼šåœ¨ `AccountsEventListener` å†…è”è°ƒç”¨ Fullnode REST `GET /transactions/by_version/{version}` è·å– `hash` ä¸ `timestamp`ã€‚
- Anchorï¼š`apps/bff/src/modules/accounts/event-listener.service.ts`ï¼ˆ`resolveTxnMetaByVersion` ä¸ `processEvent` ä¸­çš„å…œåº•åˆ†æ”¯ï¼‰ã€‚
- å¤‡æ³¨ï¼šåç»­è‹¥æ‰©å±•åˆ°è®¢å•/ç†èµ”ç›‘å¬ï¼Œå†æŠ½è±¡ä¸ºç‹¬ç«‹ `FullnodeSyncService`ã€‚

## 4.4 R2 â€” æ¡£æ¡ˆå“ˆå¸Œæ ¡éªŒ
```ts
// apps/bff/src/modules/accounts/accounts.service.ts:61-85
async verifyProfileHash(address: string, file: Express.Multer.File) {
  if (!file) {
    throw new BadRequestException('Verification file is required');
  }
  const normalizedAddress = this.normalizeAddress(address);
  const account = await this.accountsRepository.findByAddress(normalizedAddress);
  const computedHash = bytesToHex(blake3(new Uint8Array(file.buffer))).toLowerCase();
  const storedHash = account.profileHashValue.toLowerCase();
  const verified = computedHash === storedHash;
  return { verified, computedHash, storedHash };
}
```
- ä¸Šä¼ æ¥å£ `POST /api/accounts/:address/verify-hash`ï¼ˆ`apps/bff/src/modules/accounts/accounts.controller.ts:41-74`ï¼‰ä½¿ç”¨ `memoryStorage`ï¼Œé™åˆ¶ 15MBï¼Œä¸å‰ç«¯æ³¨å†Œé¡µä¸€è‡´ã€‚
- å¤±è´¥æ—¶è¿”å› `400`ï¼Œå‰ç«¯åœ¨ R2 æ•°æ®æµä¸­å±•ç¤ºå“ˆå¸Œå·®å¼‚ã€‚

## 4.5 Fullnode äº‹åŠ¡å…œåº•ï¼ˆæ–°è®¾è®¡ï¼‰
> ç°ç½‘é—®é¢˜ï¼šä»…ä¾èµ– Indexer GraphQL ä¼šå¯¼è‡´äº¤æ˜“å“ˆå¸Œ/æ—¶é—´æˆ³ç¼ºå¤±ã€‚ä¸ºæ»¡è¶³æ•°æ®æµ 10.2ã€10.4ã€10.5ã€10.7 ä¸­çš„â€œFullnode å…œåº•â€èŠ‚ç‚¹ï¼Œéœ€æ–°å¢ Fullnode å®¢æˆ·ç«¯æ¨¡å—ã€‚

### 4.5.1 æ¨¡å—ç»“æ„ï¼ˆè§„åˆ’ï¼‰
| ç»„ä»¶ | Anchorï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | è¯´æ˜ |
|------|------------------------|------|
| `FullnodeModule` | `apps/bff/src/modules/fullnode/fullnode.module.ts` | æä¾› HttpModule + é…ç½®æ³¨å…¥ |
| `FullnodeClient` | `apps/bff/src/modules/fullnode/fullnode.client.ts` | å°è£… REST `GET /v1/transactions/by_version/:version`ã€`/by_hash/:hash` |
| `TxnCacheService` | `apps/bff/src/modules/fullnode/txn-cache.service.ts` | LRU ç¼“å­˜ï¼Œé¿å…é«˜é¢‘è°ƒç”¨ |
| `FullnodeSyncService` | `apps/bff/src/modules/fullnode/fullnode-sync.service.ts` | æä¾› `resolveTxnMeta({version, hash?})` API ç»™ Listener ä¸ Timeline ä½¿ç”¨ |

### 4.5.2 æ¥å…¥ç‚¹
1. `AccountsEventListener.processEvent` åœ¨å†™åº“å‰è°ƒç”¨ `FullnodeSyncService.resolveTxnMeta`ï¼Œè‹¥ Fullnode è¿”å› 404 åˆ™è®°å½•è¡¥å¿ä»»åŠ¡ã€‚
2. æœªæ¥ `OrdersEventListener`ã€`ClaimsEventListener` å…±ç”¨è¯¥æœåŠ¡ï¼Œç¡®ä¿æ—¶é—´çº¿å±•ç¤ºç»Ÿä¸€æ¥æºã€‚
3. å¯¹äºå¤±è´¥é‡è¯•ï¼Œä¿å­˜è‡³ `fullnode_missing_transactions` è¡¨ï¼ˆ`apps/bff/prisma/schema.prisma` éœ€æ–°å¢ï¼Œæœªæ¥è¡¥å……ï¼‰ã€‚

## 4.6 O1 â€” è®¢å•è‰ç¨¿ä¸ç­¾ç½²ï¼ˆè§„åˆ’ï¼‰
| åœºæ™¯èŠ‚ç‚¹ | Anchor | èŒè´£ |
|----------|--------|------|
| `OrdersDraftController` | `apps/bff/src/modules/orders/orders.controller.ts:1` | `POST /api/orders/drafts` ä¿å­˜è‰ç¨¿ã€è¿”å› `recordUid` ä¸ç­¾åè½½è· |
| `OrdersService.createDraft` | `apps/bff/src/modules/orders/orders.service.ts:1` | æ ¡éªŒä»“åº“/å–å®¶æ³¨å†ŒçŠ¶æ€ã€è°ƒç”¨ Prisma å†™å…¥ `orders` è‰ç¨¿è¡¨ |
| `OrdersEventListener` | `apps/bff/src/modules/orders/orders-event-listener.service.ts:1` | ç›‘å¬ `OrderCreated` ç­‰äº‹ä»¶ï¼Œç»“åˆ Fullnode æ•°æ®æ›´æ–°è®¢å•çŠ¶æ€ |
| `OrdersTimelineRepository` | `apps/bff/src/modules/orders/orders.repository.ts:1` | ç»´æŠ¤æ—¶é—´çº¿ã€åª’ä½“å¼•ç”¨ï¼Œä¸ `MediaAsset` è¡¨å…³è” |

- æ‰€æœ‰è®¢å•ç›¸å…³ API å¿…é¡»ä¾èµ–æ–°å»ºçš„ `FullnodeSyncService` è·å–äº‹åŠ¡å“ˆå¸Œä¸æ—¶é—´æˆ³ï¼Œå¦åˆ™æ ‡è®°ä¸ºâ€œå¾…è¡¥å¿â€ã€‚

## 4.7 O2 â€” åª’ä½“ä¸Šä¼ ä¸å‡ºåº“æ—¶é—´çº¿
### 4.7.1 ç°æœ‰ä¸Šä¼ æœåŠ¡
```ts
// apps/bff/src/modules/media/media.service.ts:33-124
async handleUpload(file: Express.Multer.File | undefined, rawBody: RawUploadMediaBody) {
  if (!file) {
    throw new BadRequestException('Upload file is required');
  }
  const body = this.normalizeBody(rawBody);
  if (!body.recordUid) {
    throw new BadRequestException('record_uid is required');
  }
  const normalizedHashAlgorithm = this.normalizeHashAlgorithm(body.hashAlgorithm);
  if (body.hashAlgorithm && !normalizedHashAlgorithm) {
    throw new BadRequestException('Unsupported hash algorithm');
  }
  const normalizedStage = this.normalizeStage(body.stage);
  const normalizedCategory = body.category ? body.category.toLowerCase() : undefined;
  this.assertFileAllowed(file);
  const computedHash = this.computeBlake3(file.buffer);
  if (body.hashValue) {
    const normalizedExpected = this.normalizeHash(body.hashValue);
    if (computedHash !== normalizedExpected) {
      throw new BadRequestException({
        message: 'Hash mismatch between client and server',
        code: ORDER_MEDIA_ERROR_CODES.HASH_MISMATCH
      });
    }
  }
  const stored = await this.storage.save({
    buffer: file.buffer,
    originalName: file.originalname,
    mimeType: file.mimetype,
    recordUid: body.recordUid,
    stage: normalizedStage,
    category: normalizedCategory
  });
  const stage = normalizedStage ?? ORDER_MEDIA_STAGES.INBOUND;
  const category = normalizedCategory ?? this.resolveCategory(file.mimetype);
  const uploadedAt = new Date();
  await this.repository.recordUpload({
    recordUid: body.recordUid,
    stage,
    category,
    storagePath: stored.storagePath,
    publicPath: stored.publicPath,
    hashAlgo: ORDER_MEDIA_HASH_ALGORITHMS.BLAKE3,
    hashValue: computedHash,
    mimeType: file.mimetype,
    sizeBytes: file.size,
    uploadedBy: body.address,
    uploadedAt
  });
  return {
    recordUid: body.recordUid,
    stage,
    category,
    hashAlgorithm: normalizedHashAlgorithm ?? ORDER_MEDIA_HASH_ALGORITHMS.BLAKE3,
    hashValue: computedHash,
    crossCheckHashAlgorithm: body.crossCheckHashAlgorithm ? this.normalizeHashAlgorithm(body.crossCheckHashAlgorithm) : undefined,
    crossCheckHashValue: body.crossCheckHashValue ? this.normalizeHash(body.crossCheckHashValue) : undefined,
    sizeBytes: file.size,
    mimeType: file.mimetype,
    storagePath: stored.storagePath,
    path: stored.publicPath,
    uploadedBy: body.address,
    uploadedAt: uploadedAt.toISOString(),
    matchedOffchain: false,
    verificationStatus: ORDER_MEDIA_VERIFICATION_STATUSES.PENDING,
    hash: {
      algo: ORDER_MEDIA_HASH_ALGORITHMS.BLAKE3,
      value: computedHash
    }
  };
}
```
- ä¸Šä¼ è¯·æ±‚èµ° `POST /api/media/uploads`ï¼ˆ`apps/bff/src/modules/media/media.controller.ts:24-55`ï¼‰ï¼Œè¿”å›é“¾ä¸‹å­˜è¯ä¿¡æ¯ä¾›å‰ç«¯ç¼“å­˜ã€‚
- æ•°æ®è½åœ°åˆ° `MediaAsset` è¡¨ï¼ˆ`apps/bff/prisma/schema.prisma:34-55`ï¼‰ï¼Œåç»­ç”±è®¢å•æ—¶é—´çº¿èšåˆã€‚

### 4.7.2 å‡ºåº“ç›‘å¬ï¼ˆè§„åˆ’ï¼‰
- `OrderFulfillmentListener` å°†åœ¨ `apps/bff/src/modules/orders/orders-fulfilment-listener.service.ts`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰è§£æ `CheckedIn`ã€`SetInStorage`ã€`CheckedOut` äº‹ä»¶ï¼Œå†™å…¥ `order_events` è¡¨ã€‚
- éœ€ä¸ `MediaAsset` è¿›è¡Œå“ˆå¸Œå¯¹è´¦ï¼Œè‹¥ç¼ºå¤±åˆ™è§¦å‘è¡¥å¿é˜Ÿåˆ—ã€‚

## 4.8 C1 / S1 â€” ç†èµ”ä¸è´¨æŠ¼æ‰©å±•ï¼ˆè§„åˆ’ï¼‰
| åœºæ™¯ | Anchorï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | å…³é”®ä»»åŠ¡ |
|------|------------------------|----------|
| ç†èµ”å¼€å¯/ç»“æ¡ˆ | `apps/bff/src/modules/claims/claims.controller.ts`ã€`claims.service.ts`ã€`claims-event-listener.service.ts` | è‰ç¨¿ä¿å­˜ã€äº‹ä»¶ç›‘å¬ã€èµ”ä»˜å®¡æ‰¹å¯¹æ¥ Opsï¼Œä½¿ç”¨ Fullnode å…œåº•äº‹åŠ¡ |
| è´¨æŠ¼çŠ¶æ€ & ä¿¡ç”¨æ¦œ | `apps/bff/src/modules/staking/staking.controller.ts`ã€`staking-event-listener.service.ts`ã€`credit-score.service.ts` | èšåˆ `StakeChanged` äº‹ä»¶ã€è°ƒç”¨ Fullnode æŸ¥è¯¢ä½™é¢ã€é©±åŠ¨ä¿¡ç”¨è¯„åˆ†ä»»åŠ¡ |

- æ‰€æœ‰è§„åˆ’æ¨¡å—åº”å¤ç”¨ `TxnCacheService`ï¼Œé¿å…é‡å¤å®ç° Fullnode è°ƒç”¨ã€‚
- ä¸ Hasura/åˆ†æä»»åŠ¡å¯¹æ¥éœ€åœ¨ `configuration` ä¸­è¡¥å……å¯¹åº” URL ä¸å¯†é’¥ã€‚

## 4.9 è§‚æµ‹ä¸è¡¥å¿
- ç›‘å¬å™¨éœ€è®°å½• `transaction_version + event_index` æ¸¸æ ‡ï¼ˆ`AccountsEventListener` ä¾‹å­è§ `apps/bff/src/modules/accounts/event-listener.service.ts:52-54`ï¼‰ã€‚
- å½“ Fullnode è¯·æ±‚å¤±è´¥æ—¶ï¼Œå°†è®°å½•åˆ°è¡¥å¿è¡¨å¹¶åœ¨åå°ä»»åŠ¡ä¸­é‡è¯•ï¼ˆæ–°å¢ `apps/bff/src/modules/fullnode/fullnode-retry.task.ts`ï¼Œæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ã€‚
- æŒ‡æ ‡å»ºè®®ï¼š
  1. Indexer æ‹‰å–å»¶è¿Ÿï¼ˆäº‹ä»¶æ—¶é—´æˆ³ vs. BFF å¤„ç†æ—¶é—´ï¼‰ï¼›
  2. Fullnode é‡è¯•æ¬¡æ•°ï¼›
  3. ä¸Šä¼ å“ˆå¸Œæ ¡éªŒå¤±è´¥ç‡ï¼›
  4. Prisma å†™åº“è€—æ—¶ã€‚

> **è½åœ°è¦æ±‚**ï¼šå®ç°ä¸Šè¿°è§„åˆ’æ¨¡å—æ—¶ï¼Œå¿…é¡»å…ˆåœ¨æ–‡æ¡£ä¸­è¡¥å……å¯¹åº” Anchor ä¸æ ¸å¿ƒä»£ç ç‰‡æ®µï¼Œå†æäº¤ä»£ç ï¼Œç¡®ä¿é“¾ä¸Š/é“¾ä¸‹/å‰ç«¯ä¸‰ç«¯è¯­ä¹‰ä¿æŒä¸€è‡´ã€‚
