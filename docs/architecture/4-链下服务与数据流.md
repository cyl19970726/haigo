# 4. 链下服务与数据流

本章节同步 HaiGo Epic 1（链上注册基线）下的实际交付内容，并将尚未实现的功能统一标记为 Roadmap。当前代码仅包含账户注册事件的索引与查询，订单、媒体与理赔相关数据流将在后续迭代逐步补齐。

## 4.1 当前交付范围（Epic 1）
### 4.1.1 架构概览
- **BFF 技术栈：** NestJS + Express，入口模块在 `apps/bff/src/main.ts`，配置由 `@nestjs/config` 加载 `src/common/configuration.ts`。
- **模块导入约束：** Monorepo 各包统一运行在 ESM（NodeNext）语义下。BFF 直接通过 `@haigo/shared` 包引入共享常量/类型，严禁再手动 `require` `packages/shared/src/**` 等源码路径。
- **职责：**
  1. 轮询 Aptos Indexer GraphQL 获取 `SellerRegistered`、`WarehouseRegistered`、`PlatformOperatorRegistered` 事件；
  2. 将事件映射为 `Account` 记录写入 Postgres (Prisma ORM)；
  3. 暴露查询与哈希校验 REST API，供前端 Story 1.3/1.4 使用。
- **数据流：**
  ```mermaid
  flowchart LR
    MoveEvents[Move Events<br/>registry::SellerRegistered / WarehouseRegistered] --> Indexer[Aptos Indexer<br/>GraphQL]
    Indexer -->|poll| AccountsEventListener
    AccountsEventListener -->|upsert| Postgres[(Postgres<br/>accounts 表)]
    Postgres --> Prisma[Prisma Client]
    Prisma --> AccountsService
    AccountsService -->|REST| API[GET/POST /api/accounts/*]
    API --> Frontend[apps/web Registration Flow]
  ```

### 4.1.2 事件轮询 & 游标管理
- `AccountsEventListener` (`apps/bff/src/modules/accounts/event-listener.service.ts`)
  - 在 `onModuleInit` 中执行 `bootstrapCursor`，从数据库读取最近一次处理过的 `txnVersion` + `eventIndex`，无记录时从 `-1` 开始；
  - `REGISTRATION_EVENTS_QUERY` 轮询 Indexer，使用 `_gt`/`_eq` 条件保证顺序处理；
  - 每批处理完毕后更新内存游标，写入数据库由 `getLatestProcessedEvent` 负责；
  - 轮询互斥 `isPolling`，若上一轮尚未结束则跳过，避免并发；
  - 错误日志使用 `Logger.error` 输出堆栈，等待下个 interval 继续。
- 配置项读取：
  - `indexerUrl = configService.get('indexerUrl')`（默认 `https://indexer.testnet.aptoslabs.com/v1/graphql`）；
  - `pollingIntervalMs = ingestion.pollingIntervalMs`（默认 30s）；
  - `pageSize = ingestion.pageSize`（默认 50）。
- GraphQL 变量：
  - `cursorVersion`: `lastTxnVersion.toString()`；
  - `cursorEventIndex`: `Number(lastEventIndex)`。

### 4.1.3 事件映射
- 根据事件 `type` 判断角色：`SellerRegistered` → `seller`，`WarehouseRegistered` → `warehouse`，其余默认 `seller` 并打印警告。
- 哈希字段：支持两种格式
  1. `data.profile_hash`（对象或字符串）；
  2. `data.profile_hash_value` 纯字符串。
- `ensureLowercaseHash` 校验 64 字符小写十六进制；异常直接抛错（该事件不会写入数据库）。
- `accountAddress` 来源优先级：`data.account` > `data.address` > `event.account_address`。

## 4.2 数据模型（Prisma / Postgres）
| 字段 | 类型 | 说明 |
|------|------|------|
| `account_address` | `TEXT` (PK) | 注册地址，统一小写 hex |
| `role` | `AccountRole` (`seller`/`warehouse`) | 角色枚举 |
| `profile_hash_algo` | `TEXT` | 默认 `blake3`，与链上 `hash_algorithm` 对应 |
| `profile_hash_value` | `TEXT` | 64 位十六进制哈希（小写） |
| `profile_uri` | `TEXT` 可空 | 预留链下档案存储地址 |
| `registered_by` | `TEXT` | 事件中的签名地址，通常与 `account_address` 相同 |
| `txn_version` / `event_index` | `BIGINT` | 唯一性游标，建有联合索引 |
| `txn_hash` | `TEXT` | 便于前端展示交易哈希 |
| `chain_timestamp` | `TIMESTAMPTZ` | 事件时间 |
| `created_at` / `updated_at` | `TIMESTAMPTZ` | Prisma 自动填充 |

- Prisma 定义位于 `apps/bff/prisma/schema.prisma`；运行 `pnpm --filter @haigo/bff prisma migrate deploy` 同步数据库结构。
- 索引器游标由 `AccountRepository.getLatestProcessedEvent()` 基于 `txn_version`/`event_index` 排序获取。

## 4.3 REST API（已实现）
| 方法 | 路径 | 描述 | 备注 |
|------|------|------|------|
| `GET` | `/api/accounts/:address` | 查询账户角色、档案哈希、注册时间、订单计数（若 Hasura 可用） | 响应包裹 `{ data, meta }`，并在 Header 附 `x-haigo-trace-id` |
| `POST` | `/api/accounts/:address/verify-hash` | 上传文件重新计算 BLAKE3 哈希并与数据库对比 | Multer 内存存储，文件大小上限 15MB |

> `POST /api/media/uploads` 及订单相关 API 尚未实现。前端 Story 1.3 目前依赖本地缓存或 Mock，在接口落地前会保持错误提示。

## 4.4 核心模块
### 4.4.1 AccountsService (`apps/bff/src/modules/accounts/accounts.service.ts`)
- `getAccountProfile`
  - 地址校验（小写 hex，1–64 位）失败时抛 `BadRequestException`；
  - 若不存在则抛 `NotFoundException`；
  - 聚合结果包含：角色、哈希、可选 `profileUri`、`registeredAt` ISO 字符串；
  - 调用 `fetchOrderCount`（Hasura GraphQL，可选）获取卖家/仓主订单数量；失败时只记录警告。
- `verifyProfileHash`
  - 使用 `@noble/hashes/blake3` + `bytesToHex` 重新计算哈希；
  - 返回 `{ verified, computedHash, storedHash }`。

### 4.4.2 AccountsController (`accounts.controller.ts`)
- 使用 `FileInterceptor` + `memoryStorage()` 接收上传文件；
- `createResponseMeta` 生成 `requestId`/`timestamp` 并透传 `x-haigo-trace-id`；
- 错误处理交由 Nest 默认机制，统一 JSON 包装。

### 4.4.3 AccountsRepository (`accounts.repository.ts`)
- `upsertFromEvent` 采用 Prisma `upsert`，以 `account_address` 为主键；
- `findByAddress` 返回模型映射；
- `getLatestProcessedEvent` 获取最大 `txn_version` + `event_index`。

## 4.5 配置与环境变量
| 变量 | 默认值 | 作用 |
|------|-------|------|
| `PORT` | `3001` | BFF 服务监听端口 |
| `DATABASE_URL` | `postgres://postgres:postgres@localhost:5432/haigo` | Postgres 连接串 |
| `HASURA_URL` | `http://localhost:8080` | `AccountsService` 访问 Hasura GraphQL 的基础地址（会自动拼接 `/v1/graphql`） |
| `APTOS_INDEXER_URL` | `https://indexer.testnet.aptoslabs.com/v1/graphql` | 官方 Indexer GraphQL 终端 |
| `ACCOUNT_INGESTOR_INTERVAL_MS` | `30000` | 事件轮询间隔（毫秒） |
| `ACCOUNT_INGESTOR_PAGE_SIZE` | `50` | 每次抓取事件条数 |

> 以上变量在 `apps/bff/src/common/configuration.ts` 中集中管理，可通过 Nest ConfigModule 注入。

## 4.6 运行与测试
- **本地开发：**
  1. 启动 `docker/compose.poc.yml`（Postgres + Hasura）；
  2. `pnpm --filter @haigo/bff dev` 运行 Nest 服务；
  3. 需要 Hasura 时执行 `hasura/metadata` 中的导入脚本。
- **单元测试：** `pnpm --filter @haigo/bff test` 覆盖 AccountsService/Repository 行为；
- **Lint：** `pnpm --filter @haigo/bff lint`。

## 4.7 Roadmap：订单与媒体流水线
> 以下内容为 Epic 2+ 的规划纲要，代码尚未实现，保留是为了维持上下游文档连贯性。

### 4.7.1 订单数据摄入（规划）
- 监听 `orders::OrderCreated` 等事件，填充 `orders`, `order_events` 表；
- 结合 Hasura 提供订单时间线、仓主任务队列等接口；
- 与前端订单/仓主面板联动。

### 4.7.2 媒体存证与上传接口（规划）
- `POST /api/media/uploads`：
  - 结合对象存储/本地磁盘，返回 `recordUid`, `path`, `hash`；
  - 二次校验 BLAKE3，与前端上传前的哈希对比；
  - 生成可配置过期时间的访问链接。
- `media_assets` 表：`record_uid`, `storage_path`, `hash_algo/value`, `mime_type`, `size_bytes`, `uploaded_by`, `uploaded_at`。

### 4.7.3 理赔与评分（规划）
- 监听 `ClaimOpened`、`ClaimResolved`、`RatingSubmitted` 等事件；
- 扩展 BFF 模块为多租户服务或分离微服务。

### 4.7.4 Roadmap 依赖
- 需要：
  - Move 合约扩展（订单/理赔/评分模块）；
  - Hasura metadata 扩展；
  - BFF 新模块（Orders, Media, Claims, Ratings）；
  - 前端 UI 增量故事；
  - 文件存储（本地磁盘或云对象存储）选型与权限策略。

## 4.8 监控与运维建议
- 将 AccountsEventListener 轮询日志输送到集中日志（如 Loki / CloudWatch），关注错误告警；
- 关键指标：
  - 最后一次成功游标 `txn_version:event_index`；
  - 轮询失败次数；
  - REST API 延时与错误率。
- 计划中的订单/媒体服务上线后需新增存储容量、对象存储监控以及 Hasura 指标。
