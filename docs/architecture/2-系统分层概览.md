# 2. 系统分层概览
```
┌──────────────────────────────────────────────────────┐
│                       前端层 apps/web               │
│  Next.js + @aptos-labs/wallet-adapter-react          │
│  角色仪表盘、订单时间线、媒体上传、质押/理赔面板        │
└──────────────────────────────────────────────────────┘
            │ 直接调用 Aptos 钱包签名 + BFF API
┌──────────────────────────────────────────────────────┐
│               BFF / 服务层 apps/bff (NestJS)         │
│  - 钱包签名辅助、费用计算                           │
│  - 媒体上传 + 本地磁盘存储 + blake3 哈希              │
│  - 对接 Hasura/Indexer 聚合链上只读数据                │
│  - 通过 Indexer GraphQL + Fullnode REST 补齐交易元数据 │
└──────────────────────────────────────────────────────┘
            │                                  │
            ▼                                  ▼
┌────────────────────────┐    ┌────────────────────────┐
│  Aptos Move 模块        │    │ Hasura + Postgres       │
│  registry / orders /   │    │  自有媒体/运营数据与缓存     │
│  staking / insurance   │    │  （可选）                 │
└────────────────────────┘    └────────────────────────┘
            │                                  ▲
            ▼                                  │
      Aptos 节点 & RPC                 Aptos Indexer GraphQL API
```

## 2.1 全栈交互示意图
```mermaid
flowchart LR
  User[(商家/仓主/运营)] --> WebApp
  subgraph Frontend
    WebApp[apps/web\nNext.js + Wallet Adapter]
  end

  WebApp <-->|签名/交易| Wallet
  Wallet[[Aptos 钱包\nPetra/Martian]] --> AptosRPC[(Aptos Fullnode RPC)]

  WebApp -->|REST/GraphQL| BFF
  subgraph Services
    BFF[apps/bff\nNestJS]
    MediaStore[(本地媒体目录)]
    Hasura[(Hasura GraphQL)]
    Postgres[(Postgres\n运营/媒体数据)]
  end

  BFF -->|媒体上传/哈希| MediaStore
  BFF -->|查询| Hasura
  BFF -->|元数据| AptosRest[(Aptos Fullnode REST)]
  Hasura -->|读写| Postgres

  subgraph OnChain
    MoveModules[Move Modules\nregistry/orders/staking/insurance/reputation]
    AptosIndexer[(Aptos Indexer\nGraphQL API)]
    AptosRest[(Aptos Fullnode REST)]
  end

  AptosRPC <-->|交易/事件| MoveModules
  MoveModules -->|事件| AptosIndexer
  MoveModules -->|交易详情| AptosRest
  BFF -.GraphQL.-> AptosIndexer
  BFF -.REST.-> AptosRest

  Ops[(运营工具/告警)] -->|API| BFF
  Ops -->|GraphQL| Hasura

  classDef infra fill:#f7fafd,stroke:#5b8def,stroke-width:1px;
  classDef backend fill:#fdf7f3,stroke:#ffa657;
  classDef frontend fill:#f5f8ff,stroke:#6366f1;
  classDef onchain fill:#f7fff4,stroke:#22c55e;
  classDef datastore fill:#fff7fb,stroke:#d946ef;

  class WebApp frontend;
  class Wallet infra;
  class BFF,Hasura backend;
  class Postgres,MediaStore datastore;
  class MoveModules,AptosIndexer,AptosRest onchain;
  class AptosRPC infra;
```
