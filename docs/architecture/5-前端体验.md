# 5. å‰ç«¯ä½“éªŒ

> å‰ç«¯æ¶æ„ä»¥ Next.js App Routerï¼ˆ`apps/web`ï¼‰ä¸ºæ ¸å¿ƒï¼Œå›´ç»•ã€Š10-åœºæ™¯åŒ–ç«¯åˆ°ç«¯æ•°æ®æµã€‹æ‹†åˆ†é¡µé¢ä¸ Hookã€‚ä»¥ä¸‹ Anchor è¦†ç›–ç°ç½‘æ³¨å†Œæµç¨‹ï¼ˆR1/R2ï¼‰ä»¥åŠè®¢å•ã€ç†èµ”ã€è´¨æŠ¼ç­‰è§„åˆ’ç‰¹æ€§ï¼Œæ‰€æœ‰æ–°é¡µé¢å¿…é¡»å…ˆåœ¨æœ¬ç« èŠ‚ç™»è®° Anchor ä¸æ ¸å¿ƒä»£ç ç‰‡æ®µã€‚

## 5.1 æ¨¡å—é”šç‚¹ç´¢å¼•
| åŒºåŸŸ | Anchor | å®æ–½çŠ¶æ€ | åœºæ™¯ |
|------|--------|----------|------|
| å…¨å±€ Provider | `apps/web/app/providers.tsx:1` | âœ… | å…¨éƒ¨ |
| Wallet ä¸Šä¸‹æ–‡ | `apps/web/lib/wallet/context.tsx:1` | âœ… | å…¨éƒ¨ |
| NetworkGuard | `apps/web/lib/wallet/network-guard.tsx:16` | âœ… | R1ã€R2 |
| æ³¨å†Œé¡µé¢å…¥å£ | `apps/web/app/(auth)/register/page.tsx:1` | âœ… | R1ã€R2 |
| `RegisterView` ç»„ä»¶ | `apps/web/features/registration/RegisterView.tsx:132` | âœ… | R1ã€R2 |
| BFF è°ƒç”¨å°è£… | `apps/web/lib/api/registration.ts:24` | âœ… | R1ã€R2 |
| åª’ä½“ä¸Šä¼  API | `apps/web/lib/api/media.ts`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | O2 |
| è®¢å•è‰ç¨¿é¡µé¢ | `apps/web/app/(warehouse)/orders/[recordUid]/page.tsx`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | O1/O2 |
| useOrderDraft Hook | `apps/web/features/orders/useOrderDraft.ts:1` | âœ… | O1 |
| ç†èµ”å·¥ä½œå° | `apps/web/app/(operations)/claims/[recordUid]/page.tsx`ï¼ˆæœªæ¥ç›®æ ‡è·¯å¾„ï¼‰ | ğŸš§ | C1 |
| è´¨æŠ¼/ä¿¡ç”¨é¢æ¿ | `apps/web/app/(warehouse)/staking/page.tsx:1`ã€`apps/web/features/staking/StakingDashboard.tsx:1`ã€`apps/web/features/staking/hooks/useStakingIntent.ts:1` | âœ… åˆç‰ˆï¼ˆW1ï¼‰ | S1/W1 |

## 5.2 åº”ç”¨å£³ä¸é’±åŒ…ä¸Šä¸‹æ–‡
- `providers.tsx` å°† `WalletContextProvider`ã€`QueryClientProvider` ç­‰å…¨å±€ä¾èµ–æ³¨å…¥ App Routerï¼Œä¿è¯é¡µé¢æ¸²æŸ“ä¸€è‡´æ€§ã€‚
- `useWalletContext`ï¼ˆ`apps/web/lib/wallet/context.tsx:71-183`ï¼‰å°è£…é’±åŒ…è´¦æˆ·ã€ç­¾åä¸ç½‘ç»œçŠ¶æ€ï¼Œæ‰€æœ‰éœ€è¦ç­¾å/è½®è¯¢çš„ Hook å‡åº”ä¾èµ–è¯¥ä¸Šä¸‹æ–‡ï¼Œè€Œéç›´æ¥è¯»å– `@aptos-labs/wallet-adapter-react`ã€‚
- `NetworkGuard`ï¼ˆ`apps/web/lib/wallet/network-guard.tsx:16-49`ï¼‰åœ¨ R1/R2 æµç¨‹ä¸­å¼ºåˆ¶æ£€æŸ¥ `NEXT_PUBLIC_APTOS_NETWORK`ï¼Œé˜²æ­¢è·¨ç½‘ç»œæäº¤ã€‚

## 5.3 R1 â€” æ³¨å†Œæµç¨‹ UI & æ•°æ®æµ
### 5.3.1 ä¸Šä¼ ä¸ç¼“å­˜
```tsx
// apps/web/features/registration/RegisterView.tsx:361-417
const handleFormSubmit = async (event: FormEvent<HTMLFormElement>) => {
  event.preventDefault();
  if (!accountAddress) {
    setUploadError('Connect your wallet before uploading documentation.');
    return;
  }
  if (alreadyRegistered) {
    setUploadError('This address is already registered.');
    return;
  }
  if (!selectedFile || !fileMeta?.hash) {
    setFileError('Upload a valid document before continuing.');
    return;
  }
  setUploadError(null);
  setIsUploading(true);
  try {
    const response = await uploadIdentityDocument({
      file: selectedFile,
      address: accountAddress,
      role,
      hash: fileMeta.hash
    });
    if (response.hash.value.toLowerCase() !== fileMeta.hash.toLowerCase()) {
      throw new Error('Hash mismatch between client and server.');
    }
    const cachePayload: PendingProfileCache = {
      role,
      hash: fileMeta.hash,
      storagePath: response.path,
      recordUid: response.recordUid,
      fileName: fileMeta.name,
      mime: fileMeta.mime,
      sizeBytes: fileMeta.sizeBytes,
      uploadedAt: new Date().toISOString(),
      profileUri: profileUri || undefined,
      notes: notes || undefined
    };
    setCachedProfile(cachePayload);
    setUploadResult({ recordUid: response.recordUid, path: response.path, hash: response.hash.value });
    setSelectedFile(null);
  } catch (error) {
    setUploadError(error instanceof Error ? error.message : 'Failed to upload documentation.');
  } finally {
    setIsUploading(false);
  }
};
```
- `uploadIdentityDocument`ï¼ˆ`apps/web/lib/api/registration.ts:90-110`ï¼‰å°†æ–‡ä»¶é€šè¿‡ `FormData` POST åˆ° BFF `/api/media/uploads`ï¼Œå¹¶ä¸ MediaService çš„å“ˆå¸Œæ ¡éªŒä¿æŒå¯¹é½ã€‚
- æˆåŠŸä¸Šä¼ åç¼“å­˜ `PendingProfileCache`ï¼ˆ`RegisterView` å†…éƒ¨ stateï¼‰ä»¥æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚

### 5.3.2 é“¾ä¸Šæ³¨å†Œç­¾ç½²
```tsx
// apps/web/features/registration/RegisterView.tsx:562-641
const submitRegistration = useCallback(async () => {
  if (!accountAddress) {
    setTransactionState({ stage: 'failed', error: 'Connect your wallet before submitting.' });
    return;
  }
  if (!activeHash) {
    setTransactionState({ stage: 'failed', error: 'Upload documentation before signing the transaction.' });
    return;
  }
  setTransactionState({ stage: 'submitting' });
  try {
    const transactionInput = buildRegisterTransactionInput(activeHash);
    const transaction =
      simulationState.status === 'success'
        ? simulationState.transaction
        : await buildRegisterTransaction(activeHash);
    const result = await signAndSubmitTransaction(transactionInput);
    const txnHash =
      typeof result === 'string'
        ? result
        : result?.hash ??
          (typeof (result as any)?.transactionHash === 'string' ? (result as any).transactionHash : undefined) ??
          (typeof (result as any)?.txnHash === 'string' ? (result as any).txnHash : undefined) ??
          (typeof (result as any)?.result?.hash === 'string' ? (result as any).result.hash : undefined);
    if (!txnHash) {
      throw new Error('Wallet did not return a transaction hash.');
    }
    const explorerUrl = buildExplorerUrl(txnHash, networkStatus.expected);
    setTransactionState({ stage: 'pending', hash: txnHash, explorerUrl });
    try {
      await pollTransaction(txnHash);
      setTransactionState({ stage: 'success', hash: txnHash, explorerUrl });
      const immediateProfile: AccountProfile = {
        address: accountAddress,
        role,
        profileHash: { algo: 'blake3', value: activeHash },
        profileUri: profileUri || cachedProfile?.profileUri,
        registeredAt: new Date().toISOString(),
        orderCount: accountInfo?.orderCount
      };
      setAccountInfo(immediateProfile);
      void refreshAccountInfo();
    } catch (pollError) {
      setTransactionState({
        stage: 'failed',
        hash: txnHash,
        explorerUrl,
        error: pollError instanceof Error ? pollError.message : 'Failed to confirm transaction.'
      });
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Transaction submission failed.';
    const normalized = message.toLowerCase();
    const friendly = normalized.includes('reject') ? 'Signature request was declined in your wallet.' : message;
    setTransactionState({ stage: 'failed', error: friendly });
  }
}, [
  accountAddress,
  activeHash,
  simulationState,
  buildRegisterTransaction,
  buildRegisterTransactionInput,
  signAndSubmitTransaction,
  networkStatus.expected,
  pollTransaction,
  refreshAccountInfo,
  role,
  profileUri,
  cachedProfile,
  accountInfo
]);
```
- `buildRegisterTransactionInput` æ‹¼æ¥ Move å‡½æ•° `registry::register_seller`/`register_warehouse`ï¼Œä¸é“¾ä¸Š Anchor å¯¹åº”ã€‚
- æäº¤æˆåŠŸåå³æ—¶åˆ·æ–°æœ¬åœ° `AccountProfile`ï¼Œéšåè°ƒç”¨ BFF `GET /api/accounts/:address`ï¼ˆ`apps/web/lib/api/registration.ts:58-81`ï¼‰æ‹‰å–é“¾ä¸‹ç¡®è®¤ï¼Œæ»¡è¶³æ•°æ®æµ 10.2 ä¸­ FEâ†’BFF æŸ¥è¯¢æ­¥éª¤ã€‚

### 5.3.3 å“ˆå¸Œå±•ç¤ºä¸æç¤º
- `hashFileBlake3`ï¼ˆ`apps/web/lib/crypto/blake3.ts:9-12`ï¼‰åœ¨æµè§ˆå™¨ç«¯ç”Ÿæˆ 64 ä½å°å†™åå…­è¿›åˆ¶å“ˆå¸Œï¼Œä¸é“¾ä¸Š `registry::validate_hash` è§„åˆ™ä¸€è‡´ã€‚
- UI ä¸­ `STATUS_BADGE_CLASS` ä¸ç½‘ç»œçŠ¶æ€æç¤ºç›´æ¥æ˜ å°„ `WalletContext.networkStatus`ã€‚

## 5.4 R2 â€” æ¡£æ¡ˆå“ˆå¸Œæ ¡éªŒ
- `verifyHash` æŒ‰é’®è§¦å‘ `AccountsService.verifyProfileHash`ï¼Œå‰ç«¯é€šè¿‡ `fetchAccountProfile` è·å–é“¾ä¸‹å“ˆå¸Œï¼Œç”¨ `hashFileBlake3` ç»“æœä¸ BFF `storedHash` å¯¹æ¯”ï¼Œæ»¡è¶³æ•°æ®æµ 10.3ã€‚
- é”™è¯¯çŠ¶æ€é€šè¿‡ `setUploadError` åé¦ˆï¼Œä¸ BFF çš„ `ORDER_MEDIA_ERROR_CODES.HASH_MISMATCH` ä¿æŒä¸€è‡´ï¼ˆæœªæ¥å¯æ¥å…¥å…±äº«å¸¸é‡ `@haigo/shared/config/orders`ï¼‰ã€‚

## 5.5 è§„åˆ’åœºæ™¯ Anchor
| åœºæ™¯ | Anchor | è¯´æ˜ |
|------|------------------------|------|
| O1 è®¢å•è‰ç¨¿/ç­¾ç½² | `apps/web/features/orders/create/CreateOrderView.tsx`ã€`apps/web/features/orders/useOrderDraft.ts` | è°ƒç”¨ `POST /api/orders/drafts` ä¿å­˜è‰ç¨¿ï¼Œç›‘å¬ `OrdersEventListener` çŠ¶æ€ï¼›éœ€å¤ç”¨ `useWalletContext` ç­¾ç½²äº¤æ˜“ |
| O2 ä»“å‚¨å‡ºåº“ä¸åª’ä½“æ—¶é—´çº¿ | `apps/web/features/orders/outbound/OutboundProvider.tsx`ã€`useOutboundForm.ts`ã€`OrderTimeline.tsx` | æ¶ˆè´¹ BFF `/api/orders/:recordUid`ã€`/timeline`ï¼Œå±•ç¤ºåª’ä½“ä¸äº‹ä»¶ï¼Œä¸Šä¼ æˆåŠŸååˆ·æ–°æ—¶é—´çº¿ |
| C1 ç†èµ”æµç¨‹ | `apps/web/features/claims/ClaimWorkflow.tsx`ã€`useClaimTimeline.ts` | æ¥å…¥ç†èµ”è‰ç¨¿ APIï¼Œè½®è¯¢äº‹ä»¶è¿›åº¦ï¼Œéœ€å±•ç¤º Fullnode è¡¥é½çš„æ—¶é—´æˆ³ |
| S1 è´¨æŠ¼ & ä¿¡ç”¨ | `apps/web/features/staking/StakingDashboard.tsx`ã€`apps/web/features/credit/CreditLeaderboard.tsx` | èšåˆ BFF `/api/staking/:warehouseAddress` / `/api/credit/board`ï¼Œå±•ç¤ºä½™é¢ã€é”ä»“ã€ä¿¡ç”¨åˆ†å¸ƒ |

### è´¨æŠ¼æ§åˆ¶å°ï¼ˆW1 åˆç‰ˆï¼‰
å®ç°é”šç‚¹ï¼š
- `apps/web/lib/api/staking.ts:1`ï¼ˆfetchStakingIntentï¼‰
- `apps/web/features/staking/hooks/useStakingIntent.ts:1`
- `apps/web/features/staking/useStakingActions.ts:1`ï¼ˆstake/unstake/set_storage_fee é’±åŒ…ç­¾åï¼‰
- `apps/web/features/staking/StakingDashboard.tsx:1`

> **å®ç°çº¦æŸ**ï¼šåˆ›å»ºä¸Šè¿°æ–‡ä»¶å‰éœ€å…ˆæ›´æ–°æœ¬è¡¨ï¼Œå¹¶åœ¨ä»£ç ä¸­å¼•ç”¨å…±äº« DTOï¼ˆ`packages/shared/src/dto/*.ts`ï¼‰ã€‚

## 5.6 è§‚æµ‹ä¸å›å½’
- æ³¨å†Œæµç¨‹å•æµ‹ä½äº `apps/web/features/registration/RegisterView.test.tsx`ï¼Œæ¶µç›–é’±åŒ…æ–­è¿ã€å“ˆå¸Œæ ¡éªŒç­‰åœºæ™¯ï¼Œè½åœ°æ–°åŠŸèƒ½æ—¶å‚è€ƒç¼–å†™å¯¹åº” RTL æµ‹è¯•ã€‚
- ç½‘ç»œ/é’±åŒ…æ•…éšœéœ€é€šè¿‡ `WalletContext` çš„ `connectionError` ä¸ `NetworkGuard` fallback æç¤ºï¼Œä¿æŒä¸æ•°æ®æµ 10.2/10.3 çš„å¼‚å¸¸åˆ†æ”¯ä¸€è‡´ã€‚
- å‰ç«¯æ—¥å¿—åº”æºå¸¦ BFF è¿”å›çš„ `x-haigo-trace-id`ï¼Œåç»­å¯æ¥å…¥ Sentry/LogRocket å…³è”é“¾è·¯ã€‚
