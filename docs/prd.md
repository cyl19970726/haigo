# HaiGo 海行 Product Requirements Document (PRD)

## 1. 目标与背景

### 1.1 目标
- 构建基于 Aptos 的 HaiGo 海行海外家庭仓 RWA 网络，实现订单全生命周期的链上透明管理。
- 让商家能够挑选并管理可信的家庭仓伙伴，同时结合物流存证与保险机制降低履约风险。
- 为仓主提供质押信用、运营工具与激励方案，驱动稳定可靠的仓储履约表现。
- 建立合规的跨境业务运营，将关键数据上链、媒体证据链下存储并以哈希对照，兼顾审计可信度与成本效率。

### 1.2 背景概述
HaiGo 海行致力于解决跨境履约过程中信息不透明、协作效率低的问题。当前商家难以信任临时寻找的仓储伙伴，而仓主缺乏标准化工具与可验证的声誉体系。平台通过 Aptos 链记录订单状态、支付、质押与保险等关键信息，同时把体量较大的媒体证据存放于链下并存储内容哈希，实现成本可控的可信存证。基于这些链上记录，社区治理与分析模块可以激励高质量仓主、提供绩效洞察，并支撑全球扩张所需的合规信号。

### 1.3 成功指标（2025 年内）
- 活跃家庭仓数量 ≥ 150（最近 30 天至少完成一笔订单）。
- 订单闭环率 ≥ 90%（从创建到出库完成）。
- 媒体哈希校验通过率 ≥ 98%。
- 订单从入库到出库的平均时长 ≤ 5 天。
- 理赔案件平均处理时长 ≤ 3 天。

### 1.4 变更记录

| 日期       | 版本 | 描述                             | 作者  |
|------------|------|----------------------------------|-------|
| 2025-09-16 | v1.3 | 依据模板重构 PRD，并明确数据策略 | John |

## 2. 需求

### 2.1 功能性需求（FR）
1. **FR1**: 平台必须支持商家与仓主使用 Aptos 钱包地址完成注册与身份标记，并允许绑定链下档案哈希。
2. **FR2**: 系统需提供仓库筛选与列表浏览功能，支持按地区、价格、评分、质押额度与容量标签等维度过滤。
3. **FR3**: 商家应能创建订单并一次性链上支付仓储费与保险费，生成唯一 `record_uid` 并记录支付交易哈希。
4. **FR4**: 仓主须在入库时提交快递单号与媒体内容哈希，上链记录入库事件与时间戳。
5. **FR5**: 平台应维护订单状态机（ORDER_CREATED → WAREHOUSE_IN → IN_STORAGE → WAREHOUSE_OUT）并在每次状态变更时触发链上事件。
6. **FR6**: 出库流程需要记录出库单号与媒体内容哈希，上链保存出库事件与时间戳，实现订单闭环。
7. **FR7**: 质押模块需允许仓主在 Aptos 上质押 APT/USDT 并调整质押状态，同时公开质押金额与信用权重。
8. **FR8**: 保险合约必须支持商家或平台提交理赔申请（附证据哈希），并记录审批结果、赔付金额及事件。
9. **FR9**: 平台需提供仓主评分与评价流程，允许商家提交评分和链下评价哈希，并触发评价事件。
10. **FR10**: 数据索引/聚合层需实时监听链上事件，为前端提供统计、地图和排行榜等可视化接口。

### 2.2 非功能性需求（NFR）
1. **NFR1**: 所有链上合约须通过安全审计，关键函数需进行权限与签名校验，防止重放与越权操作。
2. **NFR2**: 仅关键业务字段上链，大体量媒体文件存储于链下对象存储，并保证内容哈希一致性验证。
3. **NFR3**: 系统需满足跨境合规要求，支持后续扩展 KYC/AML 流程并确保敏感信息链下管理。
4. **NFR4**: 集成高可用监控与告警能力，包括事件监听滞后、哈希校验失败与订单状态异常等场景。
5. **NFR5**: 交易与索引流程需优化 Gas 与查询性能，确保在高并发时仍能快速反馈核心状态变化。
6. **NFR6**: 平台必须支持多语言界面与面向国际用户的时区、货币显示，确保 UX 一致性。
7. **NFR7**: 提供完整的测试策略（单元、集成、事件回放）以验证状态机、保险理赔及质押流程的正确性。
8. **NFR8**: 数据留存与日志要满足可追溯性需求，支持合规审计期间的链上链下证据对照。

## 3. 用户界面设计目标

### 3.1 整体 UX 愿景
构建“可信 + 高效”的跨境仓储管理体验：商家可以快速完成下单、追踪与理赔的关键路径，仓主能清晰掌握待办与质押状态，平台运营方可实时掌握网络健康度。界面强调透明、操作可见与风险提示，强化链上数据带来的信任感。

### 3.2 关键交互范式
- 使用“卡片式步骤进度”呈现订单生命周期，结合时间线与状态标签，一目了然地追踪关键节点。
- 针对入库、出库、理赔等事件，采用多步弹窗/引导式流程，确保用户提交必要哈希、票据与说明。
- 在需要钱包签名前展示费用明细与 Gas 预估，完成后提供区块浏览器链接以及验证提示。

### 3.3 核心界面与视图
- 钱包连接与身份选择页。
- 仓库筛选与详情页，展示信用、质押、媒体哈希验证状态。
- 订单创建与支付流程，含费用拆解与媒体哈希上传指引。
- 订单详情/状态追踪页，时间线展示 ORDER_CREATED → WAREHOUSE_IN → IN_STORAGE → WAREHOUSE_OUT。
- 仓主控制台，聚合待处理订单、质押状态、评分与激励。
- 保险理赔与争议处理面板，跟踪案件与证据。
- 运营/社区仪表盘，包含地图、排行榜、告警列表。

### 3.4 无障碍与品牌
- **无障碍等级：WCAG AA**——高对比度、键盘可达、屏幕阅读器友好；哈希与交易编号提供复制按钮。
- **品牌风格**：以“可信科技 + 海洋探索”为设计基调，深蓝/青绿为主色，辅以高亮色强调状态；使用信息卡片与线性图标凸显数据可信度。

### 3.5 目标设备与平台
- **Web 自适应**：桌面与平板优先，移动端通过响应式布局覆盖下单、确认与追踪等核心流程；后续再评估原生 App。

## 4. 技术假设

### 4.1 代码库结构
- 采用 Monorepo，集中维护 Move 合约、后端索引服务、前端 dApp 与共享工具集。

### 4.2 服务架构
- 模块化单体 + 只读事件监听器：
  - 所有写操作（Create/Check-in/Set Storage/Check-out/Stake/Claim/Rate）由前端钱包直连 Aptos 完成。
  - BFF/Indexer 仅负责读取、聚合、搜索、媒体预签名上传和风控 Hook，不代签、不代付、不代理广播。
  - 读操作区分：详情与关键判断直读链或 Indexer RPC；列表/排行等可读 BFF 并在细节页再次直链校验。

### 4.3 测试策略
- Move 合约单元测试覆盖状态机、权限、事件与错误码。
- 后端与前端提供集成测试验证钱包交互、事件处理与媒体哈希校验。
- 关键链上链下流程提供模拟/回放测试，确保异常场景可复现。

### 4.4 补充假设
- 对象存储统一使用 S3/MinIO，通过预签名 URL 上传媒体，链上仅存 `ContentHash`。
- 索引数据库采用 PostgreSQL（JSONB）+ Redis 缓存；基础设施通过 Terraform 等 IaC 管理。
- 前端使用 React + Aptos 钱包适配库（Petra、Martian 等），封装交易签名、Gas 估算与事件监听。
- CI/CD 在 Monorepo 层运行：Move 编译/测试、后端 lint/test、前端 lint/build + 基础 E2E 烟测；Testnet 分支自动部署，Mainnet 发布需人工审批。
- 钱包运营密钥与敏感配置托管于 KMS/安全模块，避免明文暴露。

## 5. 范围界定与未来规划

### 5.1 当前不在范围（Out of Scope）
- 原生移动 App（iOS / Android）。
- 法币出入金与银行结算。
- 多链部署与跨链互操作能力。
- 全自动化风控/信誉评分算法（当前阶段以人工+规则为主）。
- 大规模广告/推广激励系统。

### 5.2 未来增强（Future Enhancements）
- 原生 App（离线通知、原生扫描等增强交互）。
- 法币通道、银行对账与财务自动化。
- 跨链质押、多仓协同，以及多链资产扩展。
- 高阶风控评分、AI 辅助判别与风险预警。
- 市场推广、联盟商城、增值服务等生态功能。

## 6. 安全、隐私与合规
- **最小权限**：合约严格校验调用者，前端限制合约地址白名单；支持多签/代理扩展。
- **输入校验**：限制快递单号长度、哈希算法与 Digest 长度、媒体大小/MIME 类型；按钮与交易提交防抖。
- **重放/越序防护**：`record_uid` 唯一；状态机严格按顺序执行；重复提交返回错误码。
- **数据留存策略**：订单与事件读模型长期保留；媒体在热存储保留 180 天后转冷存/归档；哈希校验日志永久存档。
- **隐私合规**：PII 仅存链下受控环境，并记录审计日志；满足 GDPR/CCPA 等删除/访问请求。
- **KYC/AML 触发规则**：订单金额阈值、仓库地理风险等级、连续高额理赔、链上异常行为等；支持白名单/黑名单配置。
- **应急响应**：定义事故升级流程、数据泄露通知时限、跨境监管沟通渠道与公告模板。

## 7. 运维与观测
- **指标监控**：链上交易成功率、确认延迟、事件消费滞后、媒体哈希校验通过率、API QPS/错误率、缓存命中率、质押总额等。
- **日志与追踪**：结构化日志 + TraceID；保留关键操作的审计记录；链上交易哈希与链下日志关联。
- **告警策略**：状态机异常、事件消费积压、哈希校验失败、Gas 或费用异常、质押/保险合约失败。
- **索引器弹性**：
  - 全量重建可在数小时内完成；事件写入具备幂等性。
  - 监控区块高度与确认延迟，延迟 > 5 分钟触发告警。
  - 处理链重组（Reorg）时保留缓冲区，必要时回滚到最近确认高度并重放事件；API 在 Reorg 期间降级提示延迟。
- **备份与灾备**：每日快照 Postgres 数据与对象存储元数据；跨区域备份；季度进行恢复演练。
- **支持机制**：7×12 一线 + 7×24 值班；SLA：P1 响应 ≤ 1 小时、P2 ≤ 4 小时；通过 Jira/Slack 升级；发布前更新 Runbook & FAQ。
- **定期任务**：媒体哈希抽样复核、冷数据归档、排行榜重算及权重调优。

## 8. Epic List (史诗列表)
1. **Epic 1: Infrastructure & On-chain Registration (基础设施与链上注册)** —— 建立 Monorepo 工程、部署核心 Move 模块与钱包接入流程，支持商家与仓主完成链上注册及链下档案哈希绑定，为后续业务流程奠定基础。
2. **Epic 2: Order Lifecycle & Media Attestation (订单全生命周期与媒体存证)** —— 实现订单创建、入库、仓储、出库的状态机与事件触发，完成链下媒体上传与哈希验证流程，确保关键节点可信留痕。
3. **Epic 3: Staking Credit & Insurance Claims (质押信用与保险理赔体系)** —— 上线仓主质押管理、信用评分、保险费率与理赔流程，形成风险控制闭环并支持异常处理。
4. **Epic 4: Operations Analytics & Compliance Monitoring (运营分析与合规监控)** —— 搭建链上事件索引、运营仪表盘、告警与合规报表，帮助平台持续优化网络绩效并满足监管要求。

## Epic 1: Infrastructure & On-chain Registration (基础设施与链上注册)
**目标**：在 Aptos 上部署基础合约，搭建 Monorepo 工程、持续集成与前端钱包接入，确保商家与仓主能够完成链上注册以及链下档案哈希绑定。

### Story 1.1 Monorepo & CI/CD Foundations (Monorepo 与 CI/CD 基座)
> 作为平台工程团队，我希望搭建 Monorepo 结构、基础包管理与 CI/CD 流水线，以便后续 Move 合约、后端与前端协同开发并自动化验证质量。

接受标准：
1: Monorepo 初始化后包含 `move/`、`apps/web`、`apps/bff` 与 `packages/shared` 等工作空间，并提供启动脚本。
2: Move、后端、前端依赖安装与环境配置脚本齐备，README 记录运行方式。
3: CI/CD 执行 Move 编译+单测、后端 lint/test、前端 lint/build，全部通过才允许合并。
4: Pipeline 生成构建工件或部署包，并在日志或文档中记录。

### Story 1.2 Core Account Move Module (核心账户 Move 模块)
> 作为合约开发者，我希望实现并部署账户注册 Move 模块，使商家与仓主地址可以在链上创建身份并存储档案哈希。

接受标准：
1: 实现 `register_seller`、`register_warehouse`，校验调用者并存储档案哈希。
2: 触发 `SellerRegistered`、`WarehouseRegistered` 事件，包含地址与哈希信息。
3: Move 单元测试覆盖成功注册、重复注册与越权访问等场景。
4: 提供部署脚本/说明，能在测试网发布并记录模块地址。

### Story 1.3 Frontend Wallet Connection & Identity Selection (前端钱包连接与身份选择)
> 作为商家或仓主，我希望在前端连接 Aptos 钱包并选择角色，完成链下资料上传与哈希绑定，以便创建受信任的账户。

接受标准：
1: 集成 Petra/Martian 等钱包，显示当前地址与网络状态。
2: 身份选择 UI 支持上传档案文件并计算内容哈希。
3: 通过钱包签名调用 `register_*`，展示 Gas 预估与交易状态，成功后提示区块浏览器链接。
4: 档案文件上传至对象存储，返回哈希与元数据并与链上记录一致。

### Story 1.4 Metadata Indexing & Record Verification API (元数据索引与档案校验接口)
> 作为后端开发者，我希望监听注册事件并暴露查询接口，让前端与平台运营能够检索账户信息并验证链下档案哈希。

接受标准：
1: 监听 `SellerRegistered` / `WarehouseRegistered` 事件并写入 Postgres。
2: 提供 REST/BFF 接口返回账户档案（地址、角色、哈希、注册时间）。
3: 实现哈希验证 API，可对链下档案重新计算哈希并与链上比对。
4: 集成测试覆盖事件消费、数据库写入与哈希验证流程。

## Epic 2: Order Lifecycle & Media Attestation (订单全生命周期与媒体存证)
**目标**：实现订单创建到出库的完整状态机，确保关键节点均有链上事件与链下媒体哈希对照。

### Story 2.1 Order Lifecycle Move Module (订单生命周期 Move 模块)
> 作为合约开发者，我希望实现订单状态机、费用记录与事件模型，让平台可在链上跟踪订单各阶段。

接受标准：
1: 定义 `create_order`、`check_in`、`set_in_storage`、`check_out` 函数与状态字段。
2: 存储费用、快递单号、时间戳、媒体哈希等关键数据。
3: 触发 `OrderCreated`、`CheckedIn`、`SetInStorage`、`CheckedOut` 事件。
4: Move 单元测试覆盖正常流程、非法状态跳转与权限校验。

### Story 2.2 Order Creation & Fee Payment Flow (订单创建与费用支付前端流程)
> 作为商家，我希望在前端选择仓库、填写费用与保险信息并一次性链上支付，以便生成唯一订单记录。

接受标准：
1: UI 支持仓库选择、费用计算（含可配置保险费率）与快递信息填写。
2: 提交交易调用 `create_order`，展示费用拆解与 Gas 预估。
3: 交易成功后显示 `record_uid`、支付哈希与状态提示。
4: 前端调用索引 API 获取订单详情并同步商家订单列表。

### Story 2.3 Inbound Media Upload & Hash Verification (入库媒体上传与哈希验证)
> 作为仓主，我希望在入库时上传照片/视频，生成媒体哈希并上链存证，确保入库证据可信。

接受标准：
1: 入库表单支持上传媒体并本地计算哈希（keccak256/blake3）。
2: 调用 `check_in` 上链记录快递单号、媒体哈希与时间戳。
3: 媒体上传至对象存储并回写元数据，链上哈希保持一致。
4: 前端展示哈希验证状态，支持重复校验并提示成功/失败。

### Story 2.4 Fulfillment & Order Closure (出库与订单闭环)
> 作为仓主或商家，我希望在出库时记录新的物流信息与媒体哈希，使订单生命周期完结并保留证据。

接受标准：
1: 出库流程区分角色权限，输入框体与入库一致。
2: 调用 `check_out`，记录出库单号、媒体哈希与时间戳，状态更新为 `WAREHOUSE_OUT`。
3: 后端监听出库事件并刷新订单索引与统计。
4: 订单详情页展示完整时间线及各节点哈希验证结果。

## Epic 3: Staking Credit & Insurance Claims (质押信用与保险理赔体系)
**目标**：提供仓主质押与信用评分机制，构建保险费率与理赔处理流程，形成风险控制闭环。

### Story 3.1 Staking Management Contract & Console (质押管理合约与前端控制台)
> 作为仓主，我希望在平台上质押 APT/USDT 并查看质押状态，以展示信用背书。

接受标准：
1: Move 合约实现 `stake` / `unstake`，记录质押金额、资产类型与事件。
2: 监听 `StakeChanged` 事件并在数据库同步仓主信用信息。
3: 前端仓主管理页面展示质押额度、历史变更与信用权重。
4: 测试覆盖质押/解押成功、余额不足、重复质押等场景。

### Story 3.2 Credit Scoring & Ranking Display (信用评分与排名展示)
> 作为平台运营者，我希望根据质押额度、订单完成率、评分等指标生成仓主信用分并展示排名。

接受标准：
1: 设计评分模型，支持配置质押权重、履约率、评价分等参数。
2: 后端定期计算信用分并写入数据库，可溯源得分构成。
3: 前端列表展示仓主信用分、质押额度、完成率并支持排序/筛选。
4: 提供信用分变动日志，记录时间、原因与触发指标。

### Story 3.3 Insurance Claims Process Implementation (保险理赔流程实现)
> 作为商家，我希望在订单异常时提交理赔申请，并跟进审批流程，保障资产安全。

接受标准：
1: Move 合约实现 `open_claim`、`resolve_claim`，记录证据哈希、决策与赔付金额。
2: 前端支持提交理赔申请，上传证据并显示当前理赔状态。
3: 平台运营控制台可对理赔进行审批，链上记录结果并触发事件。
4: 测试覆盖理赔开启、重复申请拦截、审批流程与状态同步。

### Story 3.4 Insurance Premium & Payment Validation (保险费率与支付校验)
> 作为平台方，我希望动态配置保险费率，确保订单创建时的保费计算与支付准确。

接受标准：
1: 在链上或后端配置保险费率（默认 1%），可按仓库或品类差异化。
2: 订单创建流程读取费率并计算保费，前端展示拆解明细。
3: Move 合约验证实付金额包含仓储费与保费，否则交易失败。
4: 集成测试覆盖不同费率场景下的支付与事件记录。

## Epic 4: Operations Analytics & Compliance Monitoring (运营分析与合规监控)
**目标**：建立链上事件索引、运营仪表盘、安全告警与合规报表，支持平台持续优化与监管对接。

### Story 4.1 On-chain Event Indexer & Data Warehouse (链上事件索引器与数据仓库)
> 作为数据工程团队，我希望构建稳健的事件索引器和数据库，供运营仪表盘及报表使用。

接受标准：
1: 监听订单、质押、理赔等所有事件，写入 Postgres 并保证幂等。
2: 设计数据库模式，支持订单状态、媒体哈希校验、质押记录等查询。
3: 建立高频查询索引并记录同步延迟指标。
4: 集成测试验证事件丢失或重复写入场景的处理逻辑。

### Story 4.2 Operations Dashboard & Alert Center (运营仪表盘与告警中心)
> 作为平台运营，我希望通过仪表盘查看网络健康度，并在异常时收到告警。

接受标准：
1: 仪表盘展示订单量、完成率、哈希校验通过率、质押总额、活跃仓库数等关键指标。
2: 地图或列表视图呈现仓库分布与信用排行。
3: 配置告警规则（哈希校验失败、订单长时间未进/出仓、理赔积压等），支持邮件/Slack/Webhook 通知。
4: 提供新增或调整告警策略的操作指南。

### Story 4.3 Compliance Reporting & Audit Export (合规报表与审计导出)
> 作为合规团队，我希望在需要时导出链上链下证据并生成监管报表，确保审计顺利通过。

接受标准：
1: 定义报表模板（按订单、仓库、时间段），包含链上数据和对应哈希。
2: 支持导出 CSV/JSON，并记录导出操作的审计日志。
3: 报表显示媒体哈希校验结果，确保合规审计可追溯。
4: 测试覆盖不同过滤条件与导出格式，验证性能与安全限制。

### Story 4.4 Multilingual & Timezone Support (多语言与时区支持)
> 作为全球用户，我需要平台界面与报表支持多语言与多时区显示，以提升全球化体验。

接受标准：
1: 前端实现国际化框架，提供中文/英文切换并可扩展新语言。
2: 时间显示按用户所在时区渲染，可手动调整。
3: 报表导出包含语言与时区选项，并正确转换。
4: 测试覆盖语言切换、时区换算及默认回退机制。

## 10. 检查结果报告（PM Checklist）
- **整体完成度**：95% —— 所有模板章节已补充完整并对齐最新架构原则。
- **MVP 范围评估**：Just Right —— 四大史诗覆盖核心价值，增强项明确划分至未来迭代。
- **架构准备度**：Ready —— 写直链、BFF 只读、媒体链下存储策略及运营/合规要求均已明确；索引弹性、留存策略与支持机制已记录。
- **关键风险提醒**：关注索引器追块延迟与大规模媒体校验的运维成本；上线前需完成 Move 合约审计与钱包交互 E2E 测试。

| 类别 | 状态 | 关键备注 |
|------|------|----------|
| 1. 问题定义与背景 | PASS | 成功指标量化，背景明确跨境履约痛点。 |
| 2. MVP 范围定义 | PASS | Out-of-Scope & Future Enhancements 已列出并与路线图对应。 |
| 3. 用户体验需求 | PASS | 关键流程、可访问性与设备覆盖明确。 |
| 4. 功能性需求 | PASS | FR1–FR10 与史诗故事一一对应。 |
| 5. 非功能性需求 | PASS | 安全、合规、可观测性、留存策略齐备。 |
| 6. 史诗与故事结构 | PASS | 故事为纵向切片，验收标准清晰。 |
| 7. 技术指导 | PASS | 写直链、只读 BFF、媒体哈希策略与测试要求明确。 |
| 8. 跨职能需求 | PASS | 数据、集成、运维、支持策略均有记录。 |
| 9. 清晰度与沟通 | PASS | 中文叙述统一，版本记录与术语表可查。 |

**建议下一步**：在进入架构阶段前，与技术团队确认索引回放演练计划与 Move 合约审核时间表；同步 QA 团队准备事件回放与媒体校验的测试方案。

## 11. 下一步
- **UX Expert Prompt**：
  > 基于 `docs/prd.md` 的 HaiGo 海行 PRD，请产出核心用户旅程草图与首屏信息架构，重点体现订单时间线、媒体哈希验证状态与仓主信用分展示。

- **Architect Prompt**：
  > 参照 `docs/prd.md`，请设计 HaiGo 海行 在 Aptos 上的详细架构方案，覆盖 Move 模块接口、事件索引回放机制、只读 BFF 拓扑以及媒体哈希验证流程的基础设施配置。
