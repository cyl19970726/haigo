# Story 3.2: Credit Scoring & Ranking Display

## Status
Draft

## Story
**As a** 平台运营者,
**I want** 根据仓主质押额度、订单表现与评价等指标生成信用分并展示排名,
**so that** 我能快速识别可信仓主并追踪信用变化依据。

## Acceptance Criteria
1. 设计评分模型，支持配置质押权重、履约率、评价分等参数。
2. 后端定期计算信用分并写入数据库，可溯源得分构成。
3. 前端列表展示仓主信用分、质押额度、完成率并支持排序/筛选。
4. 提供信用分变动日志，记录时间、原因与触发指标。

## Tasks / Subtasks
- [ ] 建立信用评分配置与模型定义 (AC: 1)
  - [ ] 明确质押、履约率、评价权重配置并持久化，作为评分计算输入参数。[Source: docs/prd/2-需求.md#21-功能性需求fr]
  - [ ] 关联 Story 3.1 质押账本输出，为评分模型读取仓主实时质押额度与信用权重。[Source: docs/stories/3.1.story.md#dev-notes]
  - [ ] 规划未来链上 `reputation` 模块接口，确保模型可在后续合约更新时接入评分事件。[Source: docs/architecture/3-链上合约设计.md#34-规划模块insurance--reputation]
- [ ] 实现信用分计算服务与数据存储 (AC: 1, 2, 4)
  - [ ] 在 BFF 增设评分模块，沿用事件监听/定时任务模式定期重算信用分并写入数据库。[Source: docs/architecture/4-链下服务与数据流.md#412-事件轮询--游标管理]
  - [ ] 扩展 Prisma Schema 引入信用分与变动日志表，保留版本号、来源指标与时间戳字段，满足审计要求。[Source: docs/architecture/4-链下服务与数据流.md#42-数据模型prisma--postgres][Source: docs/prd/2-需求.md#22-非功能性需求nfr]
  - [ ] 设计信用评分重算与回放机制，支持按仓主或时间范围重建信用分，便于后续 Roadmap 增强。[Source: docs/architecture/4-链下服务与数据流.md#47-roadmap订单与媒体流水线]
- [ ] 提供信用分查询与排名 API (AC: 2, 3, 4)
  - [ ] 暴露 `/api/credit-scores`、`/api/credit-scores/:address/logs` 等 REST 接口，响应格式遵循 `{ data, meta }` 约定并支持排序/筛选。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
  - [ ] 整合质押、订单完成率、评价哈希摘要等聚合字段，为前端呈现所需指标。[Source: docs/prd/2-需求.md#21-功能性需求fr]
  - [ ] 针对计算或写库失败场景继承现有日志与重试策略，确保评分数据与事件监听同步健康。[Source: docs/architecture/4-链下服务与数据流.md#412-事件轮询--游标管理]
- [ ] 构建信用排行前端体验 (AC: 3, 4)
  - [ ] 在 `apps/web/features/credit` 实现信用榜单、信用分趋势与质押仪表组件，遵循仓库详情与信用视图布局。[Source: docs/front-end-spec.md#仓库详情与信用视图]
  - [ ] 更新仪表盘/仓库详情页，展示信用分、质押趋势、完成率，并支持多条件筛选、排序与移动端适配。[Source: docs/front-end-spec.md#key-screen-layouts]
  - [ ] 为信用分变动日志提供抽屉或时间线视图，呈现触发指标与链上事件链接，保持透明可信原则。[Source: docs/front-end-spec.md#design-principles]
- [ ] 更新共享配置与文档 (AC: 1-4)
  - [ ] 在 `packages/shared` 中定义信用分 DTO、Ranking 查询入参与评分权重常量，便于前后端复用。[Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [ ] 在 Runbook 补充信用评分重算、手动校验与监控巡检步骤，衔接后续演进路线要求。[Source: docs/runbook.md#3-验证流程][Source: docs/architecture/8-演进路线.md#8-演进路线]
- [ ] 完成测试与质量验证 (AC: 1-4)
  - [ ] Move 层暂无信用分实现，如需链上校验在未来故事中补足；当前聚焦 BFF/前端单元与集成测试，运行 `npm run test --workspace apps/bff` 与 `npm run lint/test --workspace apps/web`。[Source: docs/runbook.md#8-测试策略]
  - [ ] 编写评分计算单元测试覆盖权重调整、缺失数据、重复重算等场景，确保符合 FR7 质量要求。[Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Dev Notes
- **Previous Story Insights**: Story 3.1 输出的质押账本与 `StakeChanged` 事件为评分模型提供实时质押数据；评分服务需确保依赖事件同步健康再进行计算。[Source: docs/stories/3.1.story.md#tasks--subtasks]
- **Data Models**: 现有架构仅定义 `accounts` 表，评分结果与日志模型需新增并对齐时间戳、事件游标等字段规范；相关表结构尚未在文档中提供，需要实现后回写文档。[Source: docs/architecture/4-链下服务与数据流.md#42-数据模型prisma--postgres]
- **API Specifications**: BFF 现有 API 使用 `{ data, meta }` 包装并带请求追踪头；新评分接口应沿用该模式并扩展排序/筛选参数。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
- **Component Specifications**: 信用视图需展示信用分仪表、质押趋势与历史订单，并可从桌面延展到移动端布局；评分日志应结合通知体系保持透明可信体验。[Source: docs/front-end-spec.md#仓库详情与信用视图][Source: docs/front-end-spec.md#design-principles]
- **File Locations**: 根据 Monorepo 结构，在 `apps/bff/src/modules` 新增评分模块、`apps/web/features` 增设 credit 子目录，并在 `packages/shared` 维护共享类型。[Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: 依照 Runbook 执行 BFF 与前端测试命令；评分服务需补充单元/集成测试，并预留事件回放脚本以满足后续 FR10 统计需求。[Source: docs/runbook.md#8-测试策略]
- **Technical Constraints**: 评分模型需兼容未来 `reputation` 链上模块与事件；BFF 模块应使用既有事件轮询、日志与重试机制，部署时遵循 Registry → Staking → Orders → 评分服务的初始化顺序。[Source: docs/architecture/3-链上合约设计.md#35-模块交互与依赖关系][Source: docs/architecture/4-链下服务与数据流.md#412-事件轮询--游标管理]

### Testing
- 执行 `npm run test --workspace apps/bff` 与 `npm run lint/test --workspace apps/web` 验证评分服务与前端组件；补充单元测试覆盖权重调整、缺失指标、重算与日志写入等关键场景，符合 FR7 对全面测试策略的要求。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-02-21 | v0.1 | 初始草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
