# Story 1.3: Frontend Wallet Connection & Identity Selection

## Status
Approved

## Story
**As a** merchant or warehouse operator,
**I want** to connect my Aptos wallet, choose my identity, upload required documentation, and complete on-chain registration,
**so that** I can create a trusted HaiGo account with synchronized on-chain and off-chain records.

## Acceptance Criteria
1. Integrate Petra/Martian wallet support, display current address/network status, and block actions when the wallet network differs from the configured deployment target.
2. Provide an identity selection interface that lets users upload documentation, computes the file's BLAKE3 hash, and prepares metadata for registration.
3. Invoke `register_seller` or `register_warehouse` via wallet signature, showing gas estimates, transaction progress, success confirmation, and a block explorer link.
4. Upload documentation to object storage through the BFF, returning hash and metadata that match on-chain records to guarantee consistency.

## Tasks / Subtasks
- [x] Implement wallet connection shell (AC: 1)
  - [x] Configure `apps/web` to bootstrap `@aptos-labs/wallet-adapter-react` provider in `app/layout.tsx`, wrapping the entire app. Create wallet context in `lib/wallet/context.tsx` exposing connection state, account info, network details, and connection/disconnection methods. [Source: docs/architecture/5-前端体验.md#5-前端体验]
  - [x] Guard routes with network validation, comparing the connected wallet network to `NEXT_PUBLIC_APTOS_NETWORK`, and surface mismatch warnings with clear instructions to switch networks before enabling registration actions. Implement retry mechanism for network checks. [Source: docs/architecture/6-部署与环境.md#6-部署与环境]
  - [x] Render current wallet address (truncated with copy-to-clipboard), connection status indicator, network badge, and wallet switching UI within the registration view using design-system components. Handle wallet disconnection gracefully by redirecting to connection prompt. [Source: docs/front-end-spec.md#information-architecture-ia]
- [x] Build identity selection and document intake UI (AC: 2)
  - [x] Create a registration page under `apps/web/app/(auth)/register` with tabs/cards for seller vs warehouse roles following the IA for Merchant Workspace → Settings & Identity. [Source: docs/front-end-spec.md#information-architecture-ia]
  - [x] Implement file upload widget that reads files client-side, computes BLAKE3 256-bit hashes using a WASM library (e.g., `@noble/hashes/blake3`) encoded as 64-character lowercase hex, and previews metadata prior to submission. Include file type validation (PDF, JPG, PNG), size limits (≤15MB for images, ≤200MB for documents), and drag-and-drop support. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
  - [x] Capture optional profile URI or notes for later storage while enforcing required fields (document upload, role selection) and accessibility guidelines (labels, error states, ARIA attributes, keyboard navigation). [Source: docs/front-end-spec.md#accessibility-requirements]
- [x] Orchestrate BFF media upload and profile caching (AC: 2, 4)
  - [x] Call `POST /api/media/uploads` with multipart payload including role-specific context, store the returned storage path and hash, and assert consistency with client-side hash prior to registration call. [Source: docs/architecture/4-链下服务与数据流.md#44-bff-api-接口规范]
  - [x] Persist pending profile metadata in local state/session so users can retry registration without re-uploading. [Source: docs/architecture/4-链下服务与数据流.md#41-bff--media-ingestor]
  - [x] Hydrate existing registration state via `GET /api/accounts/:address` to disable duplicate submissions and display registered hash information. [Source: docs/architecture/4-链下服务与数据流.md#44-bff-api-接口规范]
- [x] Execute on-chain registration flows (AC: 3)
  - [x] Wire transaction builders that call `register_seller` / `register_warehouse` using module addresses from `packages/shared/src/config/aptos.ts`, including signer role guards and input validation. Handle wallet signature rejections gracefully with retry options. [Source: docs/runbook.md#6-部署与环境]
  - [x] Implement gas estimation using wallet adapter simulation APIs, presenting estimated fees in APT with USD conversion, transaction size, and requiring explicit user confirmation before submission. Handle simulation failures with fallback estimates. [Source: docs/epic/epic-1-infrastructure-on-chain-registration-基础设施与链上注册.md#story-13-frontend-wallet-connection-identity-selection-前端钱包连接与身份选择]
  - [x] Display real-time transaction status with progress indicators (submitted → pending → executed), surface detailed errors from Aptos RPC with user-friendly messages, implement exponential backoff for status polling, and provide block explorer links once confirmed. Handle timeout scenarios and retry mechanisms. [Source: docs/epic/epic-1-infrastructure-on-chain-registration-基础设施与链上注册.md#story-13-frontend-wallet-connection-identity-selection-前端钱包连接与身份选择]
- [x] Integrate shared state and UX polish (AC: 1-4)
  - [x] Store registration completion details in `packages/shared/src/dto`-aligned structures (using `AccountProfile` interface) for reuse across dashboards. [Source: docs/architecture/4-链下服务与数据流.md#46-核心接口与类设计]
  - [x] Apply design tokens and responsive layout rules (grid, spacing, accessibility) to registration screens to match UX spec. [Source: docs/front-end-spec.md#component-library--design-system]
  - [x] Add success messaging summarizing role, hash, and explorer link, plus next-step CTAs (e.g., proceed to orders), and handle failure retry flows with preserved inputs. [Source: docs/front-end-spec.md#user-flows]
- [x] Testing and automation (AC: 1-4)
  - [x] Add unit/integration tests covering wallet context, hash computation, BFF upload mocks, and transaction state reducers using existing front-end test tooling. [Source: docs/runbook.md#8-测试策略]
  - [x] Ensure `npm run lint --workspace apps/web` and `npm run test --workspace apps/web` run clean locally and in CI (note: currently test command echoes "No web tests defined yet" - implement actual test framework such as Jest/Vitest with React Testing Library for component tests). [Source: docs/runbook.md#8-测试策略]

## Dev Notes
- **Previous Story Insights**: Story 1.2 delivers the on-chain registry module and enforces BLAKE3 hashing for profile metadata; front-end registration flows must align with those validation rules and capture module addresses from shared config. [Source: docs/stories/1.2.story.md#story-12-core-account-move-module]
- **Data Models**: Use `AccountProfile` DTO structure with `role`, `profileHash: { algo: 'blake3'; value: string }`, and ISO `registeredAt` timestamps when caching registration state or calling BFF APIs. Hash values must remain 64-character lowercase hex strings using BLAKE3 algorithm. [Source: docs/architecture/4-链下服务与数据流.md#46-核心接口与类设计]
- **API Specifications**: Interact with `/api/accounts/:address` for status checks and `/api/media/uploads` for documentation uploads; ensure responses integrate with UI state management. [Source: docs/architecture/4-链下服务与数据流.md#44-bff-api-接口规范]
- **Component Specifications**: Follow wallet connection and identity layout guidelines from the UX spec, using responsive grids and accessibility rules for forms and status messaging. [Source: docs/front-end-spec.md#component-library--design-system]
- **File Locations**:
  - Place wallet context/hooks within `apps/web/lib/` and identity-specific components or pages under `apps/web/app/(auth)/register` per the repository structure. [Source: docs/architecture/high-level-architecture.md#repository-structure]
  - Share typed helpers via `packages/shared/src/dto` and `packages/shared/src/config/aptos.ts` (exports `APTOS_MODULE_ADDRESS` and `NETWORK_NAME`) to keep module addresses consistent. [Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**:
  - Implement test framework (Jest/Vitest + React Testing Library) for unit and integration tests covering wallet context, BLAKE3 hash computation utilities, BFF API mocks, and transaction state management. [Source: docs/runbook.md#8-测试策略]
  - Include coverage for accessibility behaviors (focus management, error messaging, keyboard navigation) using component tests with @testing-library/jest-dom matchers. [Source: docs/front-end-spec.md#accessibility-requirements]
  - Add E2E tests using Playwright or Cypress for wallet connection, registration flow, and transaction simulation with mock Aptos responses.
- **Error Handling Specifications**:
  - **Wallet Connection Errors**: Handle wallet not installed, user rejection, network mismatch, and timeout scenarios with specific error messages and recovery actions
  - **File Upload Errors**: Validate file types, sizes, and handle BLAKE3 computation failures with clear user feedback and retry options
  - **Transaction Errors**: Parse Aptos RPC error codes (insufficient funds, invalid transaction, network congestion) and display user-friendly messages with suggested actions
  - **Network Errors**: Implement retry logic with exponential backoff for API calls, handle offline scenarios, and provide fallback UI states
  - **Form Validation**: Real-time validation for required fields, file constraints, and wallet requirements with accessibility-compliant error messaging

- **Technical Constraints**:
  - Enforce network consistency with the configured Aptos environment before permitting registration. [Source: docs/architecture/6-部署与环境.md#6-部署与环境]
  - Use BLAKE3 hashing with 64-character lowercase hex output to satisfy registry ingestion rules and downstream BFF validation. BLAKE3 library must support browser environments and provide deterministic results. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
  - Surface transaction statuses and explorer links to maintain transparency per epic requirements. [Source: docs/epic/epic-1-infrastructure-on-chain-registration-基础设施与链上注册.md#story-13-frontend-wallet-connection-identity-selection-前端钱包连接与身份选择]
  - **Performance Requirements**: File hash computation must not block UI thread (use Web Workers if needed), wallet operations should complete within 30 seconds, and UI must remain responsive during all async operations
- **Project Structure Notes**: Implementations should align with the monorepo layout and shared tooling established in Story 1.1; no structural deviations expected. [Source: docs/architecture/high-level-architecture.md#repository-structure]

### Testing
- **Framework Setup**: Install and configure Jest/Vitest with React Testing Library, @testing-library/jest-dom, and MSW for API mocking
- **Test Coverage Requirements**:
  - Wallet provider context and connection state management hooks
  - BLAKE3 hash computation utilities with known test vectors
  - Registration form validation and error handling
  - Transaction status tracking and UI state updates
  - BFF API integration with mocked responses
- **Commands**: Execute `npm run lint --workspace apps/web` and implement proper `npm run test --workspace apps/web` (replacing current echo placeholder)
- **E2E Testing**: Simulate registration end-to-end using mocked Aptos client responses to verify status messaging, gas estimation, and block explorer link handling. [Source: docs/epic/epic-1-infrastructure-on-chain-registration-基础设施与链上注册.md#story-13-frontend-wallet-connection-identity-selection-前端钱包连接与身份选择]

## Change Log
| Date       | Version | Description     | Author |
| ---------- | ------- | ---------------- | ------ |
| 2025-09-17 | v0.1    | Initial draft   | Bob |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex Developer)

### Debug Log References
- No dedicated debug log; inline console traces sufficed.

### Completion Notes List
- Wallet provider/context with network guard wraps App Router and exposes Aptos SDK utilities.
- Registration UI implements role tabs, accessible document intake, and wallet status surfaces aligned with UX spec.
- BFF integration handles multipart uploads, session caching, and `/api/accounts/:address` hydration with hash consistency checks.
- On-chain flow simulates gas, manages signature retries, and tracks transaction lifecycle with explorer links and backoff polling.
- Updated Aptos TS SDK usage to construct `Ed25519PublicKey` objects before simulations, ensuring compatibility with wallet adapter expectations.
- Added Vitest + Testing Library harness with unit/integration coverage for hashing, BFF clients, network guard, and registration flow states.

### File List
- apps/web/app/layout.tsx
- apps/web/app/providers.tsx
- apps/web/app/globals.css
- apps/web/app/(auth)/register/page.tsx
- apps/web/features/registration/RegisterView.tsx
- apps/web/features/registration/RegisterView.test.tsx
- apps/web/lib/wallet/context.tsx
- apps/web/lib/wallet/network-guard.tsx
- apps/web/lib/wallet/network-guard.test.tsx
- apps/web/lib/crypto/blake3.ts
- apps/web/lib/crypto/blake3.test.ts
- apps/web/lib/api/registration.ts
- apps/web/lib/api/registration.test.ts
- apps/web/package.json
- apps/web/tsconfig.json
- apps/web/vitest.config.mts
- apps/web/vitest.setup.ts
- docs/stories/1.3.story.md

## QA Results
