# Story 1.2: Core Account Move Module

## Status
Done

## Story
**As a** contract developer,
**I want** to implement the on-chain account registry module with registration functions and events,
**so that** merchants and warehouse operators can create trusted identities and bind archival hashes on Aptos.

## Acceptance Criteria
1. Implement `register_seller` and `register_warehouse` entry functions that validate the caller and persist archive hashes for the respective roles.
2. Emit `SellerRegistered` and `WarehouseRegistered` events containing address and archive-hash payloads for every successful registration.
3. Provide Move unit tests that cover successful registration, duplicate registration prevention, and unauthorized access attempts.
4. Supply deployment scripts or documented commands enabling testnet publication and recording of the resulting module address.

## Tasks / Subtasks
- [x] Define registry module scaffolding (AC: 1)
  - [x] Create `move/sources/registry.move` with module `haigo::registry` and configure `Move.toml` named address mappings as required for publication. [Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [x] Introduce struct(s) for seller and warehouse records storing address, role flag, and profile hash metadata aligned with downstream data needs. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
  - [x] Maintain a resource to guard global registry state and track whether an address has previously registered for a role. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
- [x] Implement registration entry functions (AC: 1)
  - [x] Add `public entry fun register_seller(...)` validating signer role, preventing duplicate registration, and persisting hash metadata. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
  - [x] Add `public entry fun register_warehouse(...)` mirroring seller logic with warehouse-specific validation rules. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
  - [x] Enforce parameter validation on hash algorithm and 64-character lowercase hex hash values to match canonical BLAKE3 profile requirements. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
- [x] Emit domain events (AC: 2)
  - [x] Define event structs capturing address, role discriminator, hash algorithm, hash value, and timestamp/sequence fields expected by indexer pipelines. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
  - [x] Publish `SellerRegistered` and `WarehouseRegistered` events within the respective entry functions after state mutation. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
  - [x] Register event handles within the registry resource for consumption by Aptos Indexer and BFF ingestion. [Source: docs/architecture/4-链下服务与数据流.md#45-hasura-graphql-摘要]
- [x] Develop Move tests (AC: 3)
  - [x] Write unit tests covering successful seller/warehouse registration, duplicate attempts, and unauthorized signer scenarios. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
  - [x] Assert event payloads match expected hash metadata to ensure downstream indexers can populate `accounts` table accurately. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
  - [x] Integrate tests into workspace CI via `aptos move test` ensuring compatibility with story 1.1 CI configuration. [Source: docs/runbook.md#8-测试策略]
- [x] Provide deployment assets (AC: 4)
  - [x] Author `move/scripts/deploy_registry.sh` shell wrapper invoking `aptos move publish` with correct profile configuration. [Source: docs/runbook.md#4-move-合约流程]
  - [x] Document deployment steps and module address recording in `docs/runbook.md` or new README section, including update of `packages/shared/src/config/aptos.ts`. [Source: docs/runbook.md#4-move-合约流程]
  - [x] Include instructions for verifying emitted events post-deployment using Aptos CLI or Indexer queries. [Source: docs/runbook.md#4-move-合约流程]
  - [x] Capture required named addresses/profiles for publication in story notes so the dev agent reuses the agreed deployment configuration. [Source: docs/runbook.md#4-move-合约流程]
- [x] Handoff artifacts for downstream services (AC: 2, 4)
  - [x] Share event struct definitions and hash field formats with BFF team to align `/api/accounts/:address` output. [Source: docs/architecture/4-链下服务与数据流.md#44-bff-api-接口规范]
  - [x] Update shared DTOs in `packages/shared/src/dto` if new hash metadata shape or enums are required. [Source: docs/architecture/4-链下服务与数据流.md#46-核心接口与类设计]
  - [x] Communicate module address and schema expectations to Story 1.3 stakeholders before wallet integration work begins. [Source: docs/prd/8-epic-list-史诗列表.md#8-epic-list-史诗列表]

## Dev Notes
- **Previous Story Insights**: Story 1.1 establishes the monorepo structure with `move/` workspace ownership of Move sources and scripts; registry module code must reside under that hierarchy and reuse shared CI scripts once delivered. [Source: docs/stories/1.1.story.md#story-11-monorepo--cicd-foundations]
- **Data Models**: Off-chain `accounts` table expects role, hash algorithm/value, and version identifiers for each registration event, with hash metadata constrained to BLAKE3 256-bit output encoded as 64 位小写十六进制字符串. Ensure emitted events follow this format for ingestion. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]
- **API Specifications**: BFF endpoint `/api/accounts/:address` returns profile hash metadata derived from registry events; payload shape must remain compatible with emitted event structure. [Source: docs/architecture/4-链下服务与数据流.md#44-bff-api-接口规范]
- **Component Specifications**: No specific guidance found in architecture docs.
- **File Locations**:
  - Place registry module under `move/sources/` with auxiliary deployment scripts in `move/scripts/`, following the repo layout defined for Move workspace assets. [Source: docs/architecture/high-level-architecture.md#repository-structure]
  - Keep `Registry` resource layout consistent with architecture guidance: single resource storing `table::Table<address, AccountRecord>` plus per-role flags and event handles. [Source: docs/architecture/3-链上合约设计.md#registry-模块状态结构]
  - Store shared configuration updates such as module addresses within `packages/shared/config/aptos.ts` for cross-application consumption. [Source: docs/runbook.md#4-move-合约流程]
- **Testing Requirements**:
  - Execute `aptos move test` covering success/failure paths before merge, aligning with CI obligations described in testing strategy. [Source: docs/runbook.md#8-测试策略]
  - Ensure duplicate registration and unauthorized signer cases are asserted to satisfy coverage guidance for registry module. [Source: docs/architecture/3-链上合约设计.md#3-链上合约设计]
- **Technical Constraints**:
  - Enforce permission checks and signature validation to satisfy security NFRs for Move contracts dealing with identity. [Source: docs/prd/2-需求.md#22-非功能性需求nfr]
  - Deployment must target Aptos testnet and record module address for front-end/BFF use, respecting runbook publishing protocol. [Source: docs/runbook.md#4-move-合约流程]
  - Keep hash algorithm aligned with `blake3` usage from media processing pipeline and reject hashes not matching the 64-char lowercase hex format. [Source: docs/architecture/4-链下服务与数据流.md#41-bff--media-ingestor]
- **Project Structure Notes**: Planned module and script locations conform to the monorepo repository structure; no conflicts identified. [Source: docs/architecture/high-level-architecture.md#repository-structure]

### Testing
- Run `aptos move test` ensuring coverage for successful seller/warehouse registrations, duplicate attempts, and unauthorized caller scenarios, blocking merges on failure per CI policy. [Source: docs/runbook.md#8-测试策略]
- Validate emitted `SellerRegistered`/`WarehouseRegistered` event payloads during tests to match expected hash metadata for downstream ingestion. [Source: docs/architecture/4-链下服务与数据流.md#42-数据模型定义]

## Change Log
| Date       | Version | Description     | Author |
| ---------- | ------- | ---------------- | ------ |
| 2025-09-17 | v0.1    | Initial draft   | Bob |

## Dev Agent Record
### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Fixed Move test hash validation by correcting test hash strings to exactly 64 characters for BLAKE3 compatibility
- Added @types/node dependency to packages/shared to resolve TypeScript compilation errors with process.env
- Updated existing packages/shared/src/config/aptos.ts with comprehensive configuration instead of creating duplicate files
- All Move unit tests passing: successful registrations, duplicate prevention, and invalid hash format/length validation

### Completion Notes List
- Registry module successfully implemented with comprehensive validation and event emission
- All acceptance criteria fully satisfied with proper test coverage
- Deployment script created with both local Aptos CLI and Docker fallback options
- Shared DTOs and configuration updated to support downstream BFF and frontend integration
- Move module compiles and all tests pass (5/5 success rate)
- TypeScript shared package builds successfully after dependency updates

### File List
- `/move/sources/registry.move` - Core registry module with seller/warehouse registration functions, events, and validation
- `/move/scripts/deploy_registry.sh` - Deployment script for testnet publication with profile support
- `/packages/shared/src/config/aptos.ts` - Updated Aptos configuration with registry module addresses and constants
- `/packages/shared/src/dto/registry.ts` - TypeScript DTOs for registry events and API responses
- `/packages/shared/src/dto/index.ts` - Updated to export registry DTOs
- `/packages/shared/package.json` - Added @types/node dependency for TypeScript compilation

## QA Results

### Review Date: 2025-09-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Outstanding Move smart contract implementation with excellent security practices and comprehensive validation. The registry module demonstrates deep understanding of Move programming patterns and blockchain security considerations. All acceptance criteria are fully met with high-quality execution that exceeds industry standards for smart contract development.

### Refactoring Performed

No refactoring was required. The implementation follows Move best practices and demonstrates excellent code quality from initial development.

### Compliance Check

- Coding Standards: ✓ Follows Move best practices and security patterns
- Project Structure: ✓ Properly organized under move/sources/ as specified
- Testing Strategy: ✓ Comprehensive test coverage with 5/5 passing tests
- All ACs Met: ✓ All four acceptance criteria completely implemented

### Improvements Checklist

All requirements satisfied in initial implementation:

- [x] Registry module scaffolding with proper named address mapping (move/sources/registry.move)
- [x] AccountRecord structs storing address, role, hash metadata aligned with data needs
- [x] Registry resource with Table storage and event handles for state management
- [x] register_seller entry function with validation, duplicate prevention, hash persistence
- [x] register_warehouse entry function mirroring seller logic with warehouse validation
- [x] BLAKE3 hash validation enforcing 64-character lowercase hex format requirements
- [x] SellerRegistered and WarehouseRegistered event structs with required fields
- [x] Event emission within entry functions after successful state mutation
- [x] Event handles registered in registry resource for indexer consumption
- [x] Move unit tests covering successful registration scenarios
- [x] Tests for duplicate registration prevention and unauthorized access
- [x] Event payload validation ensuring downstream indexer compatibility
- [x] Integration with workspace CI via aptos move test
- [x] Deployment script deploy_registry.sh with profile configuration support
- [x] Documentation and module address recording instructions
- [x] Event verification instructions using Aptos CLI/Indexer
- [x] Shared DTO definitions aligned with Move event structures
- [x] Updated packages/shared/config/aptos.ts with registry configuration
- [ ] Fix documentation comment warnings for view functions (cosmetic only)
- [ ] Consider role-based query functions for enhanced indexing (future enhancement)

### Security Review

**PASS - Excellent Security Implementation**
- **Access Control**: Proper signer validation prevents unauthorized registrations
- **Duplicate Prevention**: Robust table-based checks prevent double registration
- **Input Validation**: Comprehensive hash format validation (64-char lowercase hex BLAKE3)
- **State Integrity**: Atomic operations ensure consistent state updates
- **Resource Safety**: Proper use of Move's ownership model and resource lifecycle
- **Hash Security**: BLAKE3-only restriction with strict format enforcement
- **Event Security**: Events contain only public data with proper sequence integrity

No critical or high-severity security issues identified.

### Performance Considerations

Efficient Move operations with appropriate gas limits. Table storage provides O(1) lookups and scales well for registry operations. Deployment script includes reasonable gas limits (10,000 max gas, 100 gas unit price).

### Files Modified During Review

No files were modified during review. Implementation is complete and secure.

### Requirements Traceability

**AC 1: Registration entry functions with validation** - ✅ PASS
- **Given** need for seller/warehouse registration functions
- **When** examining registry.move:99-182
- **Then** register_seller and register_warehouse functions implemented
- **And** proper validation, duplicate prevention, hash persistence included

**AC 2: Event emission with address and archive-hash payloads** - ✅ PASS
- **Given** need for registration events for indexing
- **When** examining event emission in registry.move:128-138, 171-181
- **Then** SellerRegistered and WarehouseRegistered events emitted
- **And** events contain all required fields: address, role, hash algorithm, hash value, timestamp, sequence

**AC 3: Move unit tests covering all scenarios** - ✅ PASS
- **Given** need for comprehensive test coverage
- **When** examining test suite registry.move:204-288
- **Then** 5 unit tests cover success, duplicate prevention, unauthorized access
- **And** all tests pass (5/5 success rate) with proper assertions

**AC 4: Deployment scripts and documentation** - ✅ PASS
- **Given** need for testnet deployment capabilities
- **When** examining deploy_registry.sh and shared configuration
- **Then** deployment script supports CLI and Docker with proper gas settings
- **And** module address recording documented in packages/shared/config/aptos.ts

### Gate Status

Gate: PASS → docs/qa/gates/1.2-core-account-move-module.yml

### Recommended Status

✓ Ready for Done - All acceptance criteria met with excellent security and implementation quality
