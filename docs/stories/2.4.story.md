# Story 2.4: Fulfillment & Order Closure

## Status
Approved

## Story
**As a** warehouse operator or merchant,
**I want** to capture outbound logistics updates and media hashes during fulfillment,
**so that** the order lifecycle completes with verifiable evidence on the platform timeline.

## Acceptance Criteria
1. 出库流程区分角色权限，输入框体与入库一致。
2. 调用 `check_out`，记录出库单号、媒体哈希与时间戳，状态更新为 `WAREHOUSE_OUT`。
3. 后端监听出库事件并刷新订单索引与统计。
4. 订单详情页展示完整时间线及各节点哈希验证结果。

## Tasks / Subtasks
- [ ] Implement outbound fulfillment UI (AC: 1, 4)
  - [ ] 建立 `apps/web/app/(warehouse)/orders/[recordUid]/check-out` 页面和 `apps/web/features/orders/outbound` 特性模块，遵循统一目录结构。 [Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [ ] 基于入库向导复用输入组件、无障碍语义与移动端响应式，突出角色差异（仓主 vs. 平台代办）。 [Source: docs/front-end-spec.md#仓主处理入库与出库]
  - [ ] 在完成后展示时间线终态提示与商家确认信息，保持 UX 定义的状态卡片风格。 [Source: docs/front-end-spec.md#订单时间线卡片]
- [ ] Capture outbound media and logistics data (AC: 1, 2)
  - [ ] 重用上传控件支持拖拽/移动拍摄，限制 `MediaStage::outbound` 对应的 MIME/大小，预设 `HashValue.category`（如 `outbound_manifest`）。 [Source: docs/architecture/3-链上合约设计.md#3-2-4-媒体存证字段与约束]
  - [ ] 持续使用 BLAKE3 作为主哈希，并保留 keccak256 跨检；缓存文件与哈希以应对重试。 [Source: docs/front-end-spec.md#仓主处理入库与出库]
  - [ ] 校验哈希缺失或不一致时提供阻断与纠错提示。 [Source: docs/architecture/4-链下服务与数据流.md#4-7-2-媒体存证与上传接口-规划]
- [ ] Execute `check_out` transaction with guardrails (AC: 2)
  - [ ] 构建 `haigo::orders::check_out` payload（订单 ID、物流号、BLAKE3 媒体记录、可选备注）。 [Source: docs/architecture/3-链上合约设计.md#状态机流程与守卫]
  - [ ] 复用钱包守卫校验仓主/平台代办权限以及网络一致性；展示 Explorer 链接和复制哈希操作。 [Source: docs/stories/1.3.story.md#dev-notes]
  - [ ] 拦截存在未结理赔的订单，展示保险阻断错误消息，并引导处理理赔后再出库。 [Source: docs/architecture/3-链上合约设计.md#3-4-规划模块-insurance-reputation]
- [ ] Extend BFF ingestion for checkout events (AC: 3)
  - [ ] 扩展 `OrdersEventListener` 监听 `CheckedOut`，更新 `orders`、`order_events`、`order_media_assets` 并维护 `matchedOffchain` 标记。 [Source: docs/architecture/4-链下服务与数据流.md#4-7-1-订单数据摄入-规划]
  - [ ] 同步 `chain_timestamp`、物流信息、操作人地址，供 KPI 统计与 SLA 分析使用。 [Source: docs/architecture/4-链下服务与数据流.md#4-2-数据模型-prisma-postgres]
  - [ ] 刷新派生统计（完成率、出库量）并暴露在 `/api/orders` 列表响应。 [Source: docs/architecture/4-链下服务与数据流.md#4-4-核心模块]
- [ ] Deliver refreshed APIs and UI states (AC: 3, 4)
  - [ ] 确保 `GET /api/orders/:recordUid` 返回 `WAREHOUSE_OUT` 时间线项、媒体匹配状态以及保险阻断日志。 [Source: docs/architecture/4-链下服务与数据流.md#4-3-rest-api-已实现]
  - [ ] 扩展 `packages/shared/src/dto/orders.ts` 支持 outbound timeline 数据与媒体匹配标志供前端消费。 [Source: docs/architecture/4-链下服务与数据流.md#4-4-核心模块]
  - [ ] 更新 UI 渲染所有节点哈希徽章并允许终态“重新验证”操作调用 `/api/orders/:recordUid/media-verify`。 [Source: docs/front-end-spec.md#哈希验证徽章]
  - [ ] 在订单详情与商家通知中突出显示保险阻断原因及解决链接，确保用户理解出库受限的下一步动作。 [Source: docs/front-end-spec.md#仓主处理入库与出库]
- [ ] Testing and release readiness (AC: 1-4)
  - [ ] 添加 Vitest/RTL 测试覆盖出库表单、哈希校验、保险阻断、时间线更新等场景，模拟钱包与 BFF。 [Source: docs/runbook.md#8-测试策略]
  - [ ] 为 `apps/bff` 编写单元/集成测试模拟 `CheckedOut` 事件与媒体匹配逻辑。 [Source: docs/architecture/4-链下服务与数据流.md#4-4-核心模块]
  - [ ] 在 Runbook 记录手动验证步骤（角色切换、媒体重试、哈希重验、保险阻断流程）供 QA 使用。 [Source: docs/runbook.md#7-前端运行]

## Dev Notes
- **Previous Story Insights**: Outbound流程应延续 Story 2.3 的上传/守卫实现，并严格遵守 Story 2.1 中 `check_out` 参数与状态要求。 [Source: docs/stories/2.3.story.md#dev-notes]
- **Faucet Reminder**: 在执行 `check_out` 前确认仓主或平台代办钱包的测试网余额充足，必要时按照 `docs/runbook.md#4-move-合约流程` 使用 faucet 充值。 [Source: docs/runbook.md#4-move-合约流程]
- **Data Models**: `orders`、`order_events`、`order_media_assets` 需要记录出库物流号、媒体哈希、matched 标记与 `chain_timestamp` 供 KPI 统计。 [Source: docs/architecture/4-链下服务与数据流.md#4-2-数据模型-prisma-postgres]
- **API Specifications**: 后端应提供更新后的订单详情、列表统计以及 `/api/orders/:recordUid/media-verify` 以支持终态重检。 [Source: docs/architecture/4-链下服务与数据流.md#4-3-rest-api-已实现]
- **UX Guidance**: 界面需保持仓主任务队列交互、哈希徽章与终态提示一致，并提示保险阻断原因。 [Source: docs/front-end-spec.md#仓主处理入库与出库]
- **Technical Constraints**: 继续使用 BLAKE3 哈希、`MediaStage::outbound`、角色权限校验，以及保险阻断逻辑。 [Source: docs/architecture/3-链上合约设计.md#3-2-4-媒体存证字段与约束]
- **File Locations**: Web 组件在 `apps/web/features/orders/outbound`，共享 DTO/配置仍位于 `packages/shared`，BFF 事件监听在 `apps/bff/src/modules/orders`。 [Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: `npm run lint/test --workspace apps/web` 与 `npm run test --workspace apps/bff` 必须全部通过，测试涵盖保险阻断与媒体匹配场景。 [Source: docs/runbook.md#8-测试策略]

### Testing
- **Framework & Commands**: 前端使用 Vitest + RTL，后端使用 Jest/Prisma/Nest 测试工具，运行 `npm run test --workspace apps/web`、`npm run lint --workspace apps/web` 与 `npm run test --workspace apps/bff`。 [Source: docs/runbook.md#8-测试策略]
- **Coverage Expectations**: 验证成功出库、缺失哈希、角色错误、保险阻断、索引器事件更新、哈希重验等情景。 [Source: docs/architecture/4-链下服务与数据流.md#4-7-1-订单数据摄入-规划]
- **Fixtures & Utilities**: 模拟钱包、`/api/orders`、`/api/orders/:recordUid/media-verify` 以及索引器事件，确保媒体匹配与 KPI 更新逻辑正确。 [Source: docs/architecture/4-链下服务与数据流.md#4-4-核心模块]

## Change Log
| Date       | Version | Description      | Author |
| ---------- | ------- | ---------------- | ------ |
| 2025-09-19 | v0.2    | Updated to align with new checkout ingestion, insurance, and DTO specs | Bob |
| 2025-09-20 | v0.3    | Documented merchant-facing insurance block UX per review | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
