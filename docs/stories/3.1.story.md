# Story 3.1: Staking Management Contract & Console

## Status
Draft

## Story
**As a** 仓主,
**I want** 在平台上质押 APT/USDT 并随时查看质押记录,
**so that** 我能向商家展示可信的信用背书并满足平台信用要求。

## Acceptance Criteria
1. Move 合约实现 `stake` / `unstake`，记录质押金额、资产类型与事件。
2. 监听 `StakeChanged` 事件并在数据库同步仓主信用信息。
3. 前端仓主管理页面展示质押额度、历史变更与信用权重。
4. 测试覆盖质押/解押成功、余额不足、重复质押等场景。

## Tasks / Subtasks
- [ ] 扩展 Move 质押模块并公开质押事件 (AC: 1)
  - [ ] 在 `haigo::staking` 中为仓主地址维护多资产质押账本、总额与锁仓信息，同时保留 `assert_min_credit` 的守卫路径。[Source: docs/architecture/3-链上合约设计.md#33-staking-模块]
  - [ ] 实现 `stake<CoinType>` / `unstake<CoinType>` 入口函数，限制仓主签名并复用 Registry 角色校验与错误码规范。[Source: docs/architecture/3-链上合约设计.md#35-模块交互与依赖关系][Source: docs/architecture/3-链上合约设计.md#36-权限与安全控制]
  - [ ] 定义 `StakeChanged` 事件（包含地址、币种、增量、余额、动作、时间戳）并在质押/解押时触发，满足平台公开信用要求。[Source: docs/prd/2-需求.md#21-功能性需求fr]
  - [ ] 提供 `#[view]` 读取函数用于仓主和运营端获取实时质押信息，便于前端展示。[Source: docs/prd/2-需求.md#21-功能性需求fr]
- [ ] 为质押逻辑编写 Move 测试与部署脚本 (AC: 4)
  - [ ] 覆盖成功质押、余额不足、重复质押、锁仓限制等断言，遵循现有 `aptos move test` 流程。[Source: docs/architecture/3-链上合约设计.md#38-测试与部署][Source: docs/runbook.md#8-测试策略]
  - [ ] 更新 `move/scripts` 部署脚本，确保 staking 模块在 Registry 初始化之后按推荐顺序发布。[Source: docs/architecture/3-链上合约设计.md#38-测试与部署]
- [ ] 扩展 BFF 同步质押事件并提供查询接口 (AC: 2)
  - [ ] 参考 `AccountsEventListener` 模式新增 `StakeEventListener`，轮询 `StakeChanged` 并写入新的质押表结构。[Source: docs/architecture/4-链下服务与数据流.md#41-当前交付范围epic-1]
  - [ ] 在 Prisma schema 中定义仓主质押头寸与历史记录模型，保持与现有 `accounts` 模型的时间戳、哈希字段一致。[Source: docs/architecture/4-链下服务与数据流.md#42-数据模型prisma--postgres]
  - [ ] 新增 `/api/staking/:warehouseAddress` 等 REST 接口暴露当前质押、历史曲线与最近信用权重，用于前端调用。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
  - [ ] 对接链上事件失败或写入异常时遵循现有日志与重试策略，便于监控后续扩展。[Source: docs/architecture/4-链下服务与数据流.md#412-事件轮询--游标管理]
- [ ] 构建仓主质押控制台界面与交互 (AC: 3)
  - [ ] 在 `apps/web/features/staking` 建立质押仪表、趋势图及操作面板，遵循仓主控制台信息密度与卡片布局规范。[Source: docs/front-end-spec.md#仓主详情与信用视图][Source: docs/front-end-spec.md#质押信用卡片]
  - [ ] 在 `app/(dashboard)/warehouses/[address]/stake` 页面加载质押数据、信用权重与通知，并适配移动端任务队列场景。[Source: docs/front-end-spec.md#仓主任务队列warehouse-task-queue]
  - [ ] 集成钱包交互触发质押/解押交易，复用既有连接守卫与网络提示组件。[Source: docs/front-end-spec.md#仓主处理入库与出库]
  - [ ] 引入链上交易哈希、事件状态徽章与风险提示，遵循透明可信的设计原则。[Source: docs/front-end-spec.md#design-principles]
- [ ] 更新共享类型与配置，确保多端一致性 (AC: 2,3)
  - [ ] 在 `packages/shared` 中补充质押 DTO、事件类型与合约地址配置，遵循 Monorepo 共享规范。[Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [ ] 根据需要调整前端环境变量与 BFF 配置项，记录在 Runbook 部署步骤中便于测试网同步。[Source: docs/front-end-spec.md#required-frontend-environment-variables][Source: docs/runbook.md#9-部署到测试网]
- [ ] 验证端到端流程并更新运行手册 (AC: 4)
  - [ ] 前后端执行 lint/test，与 Move 测试一并纳入流水线，确保 FR7 的完整测试策略。[Source: docs/prd/2-需求.md#22-非功能性需求nfr][Source: docs/runbook.md#8-测试策略]
  - [ ] 在 Runbook 中补充质押流程巡检与链下数据回放步骤，支持后续演进路线要求。[Source: docs/runbook.md#3-验证流程][Source: docs/architecture/8-演进路线.md#8-演进路线]

## Dev Notes
- **Previous Story Insights**: Story 2.4 强调在订单出库前检查保险阻断，后续质押信用需要与理赔状态联动，保持信息一致性。[Source: docs/stories/2.4.story.md#dev-notes]
- **Data Models**: 现有 Prisma 仅定义 `accounts` 表；质押模块需沿用时间戳、事件游标等字段设计，具体结构在架构文档中尚未提供，需在实现时补充并回写文档。[Source: docs/architecture/4-链下服务与数据流.md#42-数据模型prisma--postgres]
- **API Specifications**: 当前 BFF 暴露 `/api/accounts` 等 REST 接口；质押查询需遵循相同的 `{ data, meta }` 响应包装与日志策略，具体端点尚未在文档中定义。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
- **Component Specifications**: 质押信用卡片应展示质押总额、风险状态与趋势；仓主控制台需保留卡片化布局与通知联动，支持移动端任务入口。[Source: docs/front-end-spec.md#质押信用卡片][Source: docs/front-end-spec.md#仓主任务队列warehouse-task-queue]
- **File Locations**: 按 Monorepo 结构在 `move/`, `apps/bff`, `apps/web`, `packages/shared` 中分别实现对应模块和共享类型，保持分层一致。[Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: Move 使用 `aptos move test`；后端运行 `npm run test --workspace apps/bff`；前端执行 `npm run lint/test --workspace apps/web` 并逐步引入端到端测试，满足 FR7 质量门槛。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]
- **Technical Constraints**: 质押与订单均需经过 Registry 角色校验，错误码遵循既有 `E_INSUFFICIENT_CREDIT` 等约定；部署顺序为 Registry → Staking → Orders；事件字段需保持地址、金额、时间戳格式统一，便于 Indexer 消费。[Source: docs/architecture/3-链上合约设计.md#35-模块交互与依赖关系][Source: docs/architecture/3-链上合约设计.md#38-测试与部署]
- **Parallel Coordination**: 与 Story 2.4 并行时，保持对共享配置（如 `packages/shared/src/config/aptos.ts`、订单 DTO）与 Runbook 的沟通，避免覆盖出库流程更新；在扩展 `assert_min_credit` 或事件结构时，提前同步订单团队确认守卫逻辑与错误码未破坏出库校验。 [Source: docs/stories/2.4.story.md#dev-notes][Source: docs/architecture/high-level-architecture.md#repository-structure]

### Testing
- 运行 `aptos move test` 验证质押/解押单元测试；执行 `npm run test --workspace apps/bff` 与 `npm run lint/test --workspace apps/web` 完成链下与前端覆盖；必要时补充事件回放测试脚本以符合 FR7 的测试策略要求。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-02-21 | v0.1 | 初始草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
