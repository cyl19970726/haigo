# Story 3.3: Insurance Claims Process Implementation

## Status
Draft

## Story
**As a** 商家,
**I want** 在订单出现异常时提交保险理赔并获得平台审批结果,
**so that** 能保障资产安全并追踪赔付进度。

## Acceptance Criteria
1. Move 合约实现 `open_claim`、`resolve_claim`，记录证据哈希、决策与赔付金额。
2. 前端支持提交理赔申请，上传证据并显示当前理赔状态。
3. 平台运营控制台可对理赔进行审批，链上记录结果并触发事件。
4. 测试覆盖理赔开启、重复申请拦截、审批流程与状态同步。

## Tasks / Subtasks
- [ ] 设计并实现保险理赔 Move 模块 (AC: 1, 3)
  - [ ] 在 `haigo::insurance` 中定义理赔资源（订单关联、索赔人、证据哈希、状态、赔付金额）与 `ClaimOpened`/`ClaimResolved` 事件，保持与规划文档一致。[Source: docs/architecture/3-链上合约设计.md#34-规划模块insurance--reputation]
  - [ ] 实现 `open_claim` 时校验订单状态、重复申请与角色权限，确保依据 FR8 记录证据哈希与索赔金额。[Source: docs/prd/2-需求.md#21-功能性需求fr]
  - [ ] 实现 `resolve_claim` 供平台审批，写入决策、赔付金额并触发事件，后续将赔付金额传递给订单/索引层。[Source: docs/architecture/3-链上合约设计.md#35-模块交互与依赖关系]
  - [ ] 暴露 `assert_no_pending_claim` 等检查函数，为订单出库与质押解锁提供联动守卫。[Source: docs/stories/2.4.story.md#tasks--subtasks]
- [ ] 为理赔模块补充 Move 测试与部署脚本 (AC: 4)
  - [ ] 编写单元测试覆盖成功开案、重复申请拦截、越权审批、赔付金额写入等场景，纳入 `aptos move test`。[Source: docs/runbook.md#8-测试策略]
  - [ ] 更新 `move/scripts` 部署顺序，确保在 Registry、Staking、Orders 之后发布保险模块并记录资源账户要求。[Source: docs/architecture/3-链上合约设计.md#38-测试与部署]
- [ ] 扩展索引与 BFF 理赔服务 (AC: 1, 3, 4)
  - [ ] 参考事件轮询模式新增 `ClaimEventListener`，监听 `ClaimOpened`/`ClaimResolved` 并同步至数据库，复用游标与重试策略。[Source: docs/architecture/4-链下服务与数据流.md#412-事件轮询--游标管理]
  - [ ] 按索引草案新增 `claims` 表，记录索赔人、状态、赔付金额、事件游标等字段，保证可溯源。[Source: docs/detail/indexer-schema.md#1-5-理赔事件claimopened--claimresolved]
  - [ ] 提供 `/api/claims`, `/api/claims/:claimId`, `/api/claims/:claimId/actions` 等 REST 接口，输出 `{ data, meta }` 响应并支持状态/时间过滤。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
  - [ ] 集成链上交易提交逻辑，失败时记录状态并允许重试，保证审批动作与事件同步的一致性。[Source: docs/architecture/4-链下服务与数据流.md#47-roadmap订单与媒体流水线]
- [ ] 落地前端理赔申请与审批体验 (AC: 2, 3)
  - [ ] 在订单详情中加入理赔入口与表单，遵循多步流程、证据上传与保单确认交互。[Source: docs/front-end-spec.md#理赔申请与审批]
  - [ ] 在 `apps/web/features/claims` 构建申请表单、状态时间线、附件哈希验证与通知提示，兼顾移动端体验。[Source: docs/front-end-spec.md#design-principles]
  - [ ] 实现运营理赔审批工作台，包含列表过滤、详情抽屉、审批按钮与 SLA 计时显示。[Source: docs/front-end-spec.md#理赔审批工作台ops-claims-console][Source: docs/front-end-spec.md#理赔审批面板]
  - [ ] 集成链上交易回执与事件状态徽章，让用户可追踪申请编号、交易哈希与链上同步结果。[Source: docs/front-end-spec.md#design-principles]
- [ ] 更新共享类型、配置与文档 (AC: 1-3)
  - [ ] 在 `packages/shared` 中添加理赔 DTO、事件类型、API 请求/响应定义与错误码常量，供前后端复用。[Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [ ] 在 Runbook 记录理赔提交流程、链上交易巡检与重试步骤，支撑运营排障。[Source: docs/runbook.md#3-验证流程]
  - [ ] 回写架构文档/索引草案中的保险模块细节，保持规划与实现一致。[Source: docs/architecture/3-链上合约设计.md#34-规划模块insurance--reputation]
- [ ] 端到端测试与质量保障 (AC: 2, 3, 4)
  - [ ] 执行前端 `npm run lint/test --workspace apps/web` 与 BFF `npm run test --workspace apps/bff`，补充理赔申请/审批的集成测试与事件回放脚本。[Source: docs/runbook.md#8-测试策略]
  - [ ] 构建模拟流程（异常订单→提交理赔→审批→赔付），验证链上事件、数据库状态与前端展示一致，满足 NFR7 对理赔测试覆盖要求。[Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Dev Notes
- **Previous Story Insights**: Story 2.4 阻止在存在未结理赔的订单上执行出库；理赔模块需暴露查询接口供订单、质押逻辑调用并保持状态一致。[Source: docs/stories/2.4.story.md#tasks--subtasks]
- **Data Models**: 现有数据库仅实现账户表；理赔需参照索引草案新增 `claims` 表并记录事件游标、赔付金额、哈希字段，以便审计和回放。[Source: docs/detail/indexer-schema.md#1-5-理赔事件claimopened--claimresolved]
- **API Specifications**: 新接口需遵循 BFF 统一的 `{ data, meta }` 包装、日志与追踪头策略，并支持状态筛选与分页，供申请端与审批端使用。[Source: docs/architecture/4-链下服务与数据流.md#43-rest-api已实现]
- **Component Specifications**: 理赔表单与审批控制台需遵从多步流程、证据哈希校验、SLA 提示与透明可信的设计指导，可参考 Figma `O-Claims-01` 布局。[Source: docs/front-end-spec.md#理赔申请与审批][Source: docs/front-end-spec.md#理赔审批工作台ops-claims-console]
- **File Locations**: 按 Monorepo 结构在 `move/`、`apps/bff/src/modules/claims`、`apps/web/features/claims`、`packages/shared/src/dto` 中分别实现模块与共享类型，确保目录与文档一致。[Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: 需覆盖链上交易测试、BFF 集成测试与前端单元/交互测试，并规划事件回放脚本验证索引可靠性，满足 FR8/NFR7。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]
- **Technical Constraints**: 理赔事件需与质押/订单状态互锁，因此审批完成后必须更新 `orders::insurance_blocked` 或相关标记，确保流程闭环；部署时遵循 Registry → Staking → Orders → Insurance 的顺序。[Source: docs/architecture/3-链上合约设计.md#35-模块交互与依赖关系]

### Testing
- 运行 `aptos move test` 覆盖理赔合约单元测试；执行 `npm run test --workspace apps/bff` 与 `npm run lint/test --workspace apps/web` 验证链下与前端实现，并补充事件回放/集成测试以检验理赔申请、审批、赔付全流程。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-02-21 | v0.1 | 初始草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
