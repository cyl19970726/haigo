# Story 2.2: Order Creation & Fee Payment Flow

## Status
Approved

## Story
**As a** merchant user,
**I want** to select a warehouse, configure fees, and sign a single `create_order` transaction from the web app,
**so that** each order is created on-chain with transparent costs and immediately available in my timeline.

## Acceptance Criteria
1. UI supports warehouse selection, configurable insurance fee calculation, and logistics information capture within the order form.
2. Submitting the form invokes the on-chain `create_order` function, including fee breakdown and gas estimation prior to signature.
3. After a successful transaction, the interface shows the generated `record_uid`, payment transaction hash, and contextual status guidance.
4. The frontend refreshes order data by calling the indexer-backed API to populate the order detail view and update the merchant order list.

## Tasks / Subtasks
- [ ] Assemble merchant order creation flow (AC: 1)
  - [ ] Build `apps/web/app/(merchant)/orders/new` screens with feature logic in `apps/web/features/orders/create`, wiring breadcrumbs and CTA entry points defined in the UX flow. [Source: docs/front-end-spec.md#商家创建并支付订单]
  - [ ] Implement warehouse comparison cards exposing staking信用、媒体样本与可用性字段来自共享 DTO，帮助商家评估仓库。 [Source: docs/architecture/4-链下服务与数据流.md#478-前端后端数据契约扩展]
  - [ ] Create a multi-step form capturing批次信息、物流 carrier/单号、可选档案哈希，采用无障碍标签、键盘焦点管理与移动端响应式布局。 [Source: docs/front-end-spec.md#component-library--design-system]
  - [ ] 复用钱包守卫确保卖家身份、网络匹配与授权状态齐备后才允许提交。 [Source: docs/architecture/5-前端体验.md#5-前端体验]
- [ ] Calculate and persist fee configuration (AC: 1, 2)
  - [ ] 实时计算 `PricingRecord` 中主费用、保险费、平台费，允许调整默认保险费率并以本地化格式展示。 [Source: docs/architecture/3-链上合约设计.md#325-费用与支付约束]
  - [ ] 呈现费用确认步骤（含费率说明、Gas 预估、余额提示），符合“确认费用拆解与保险费率”交互。 [Source: docs/front-end-spec.md#商家创建并支付订单]
  - [ ] 缓存表单与费用选择，确保模拟失败或钱包中断时可恢复。 [Source: docs/front-end-spec.md#32-关键交互范式]
- [ ] Integrate `create_order` transaction pipeline (AC: 2)
  - [ ] 构建 `haigo::orders::create_order` payload，包含仓库地址、费用明细与可选初始 `MediaStage::inbound` 媒体哈希，使用共享模块地址。 [Source: docs/architecture/3-链上合约设计.md#326-story-对齐清单]
  - [ ] 调用钱包适配器执行 Gas 模拟与签名，处理余额不足、网络不匹配或模拟失败的回退提示。 [Source: docs/runbook.md#7-前端运行]
  - [ ] 展示提交进度、成功提示、区块浏览器链接与可复制交易哈希。 [Source: docs/front-end-spec.md#商家创建并支付订单]
- [ ] Synchronize order data and timelines (AC: 3, 4)
  - [ ] 解析事件中的 `order_id/record_uid`，随后调用 `GET /api/orders/:recordUid` 与 `GET /api/orders` 以刷新详情与仪表盘统计。 [Source: docs/architecture/4-链下服务与数据流.md#474-api-规划]
  - [ ] 将用户引导至订单时间线，附带下一步指引与状态徽章。 [Source: docs/front-end-spec.md#订单时间线卡片]
  - [ ] 在索引器刷新前暂存交易哈希、时间戳与媒体摘要，以便哈希徽章即时渲染。 [Source: docs/architecture/4-链下服务与数据流.md#475-媒体存证协同]
  - [ ] 在等待 `/api/orders` 更新时显示乐观状态（loading skeleton 或 toast），并清晰标注数据来源以避免用户误解。 [Source: docs/front-end-spec.md#商家创建并支付订单]
- [ ] Align shared DTOs and configuration (AC: 1-4)
  - [ ] 扩展 `packages/shared/src/dto/orders.ts`，定义 `OrderSummary`、`OrderTimelineItem`、定价辅助函数以匹配后端契约。 [Source: docs/architecture/4-链下服务与数据流.md#478-前端后端数据契约扩展]
  - [ ] 将保险费率、哈希分类、模块地址等常量集中在共享配置以便后续故事复用。 [Source: docs/architecture/high-level-architecture.md#repository-structure]
- [ ] Testing and QA readiness (AC: 1-4)
  - [ ] 编写 Vitest/React Testing Library 覆盖多步表单、费用计算、钱包守卫与时间线乐观刷新，模拟钱包/BFF 调用。 [Source: docs/runbook.md#8-测试策略]
  - [ ] 添加集成测试验证签名成功/失败、哈希校验错误与重试路径满足 UX 要求。 [Source: docs/front-end-spec.md#商家创建并支付订单]
  - [ ] 在 Runbook 中记录手动验证（连接钱包→设置费用→签名→查看时间线）以便运营交接。 [Source: docs/runbook.md#7-前端运行]

## Dev Notes
- **Previous Story Insights**: Story 2.1提供 `create_order` 所需字段与 `MediaStage` 规范，表单应按其 schema 构建；Story 1.3 的钱包守卫与哈希工具继续复用。 [Source: docs/stories/2.1.story.md#dev-notes]
- **Faucet Reminder**: 提交 `create_order` 交易前确认钱包余额充足，若不足请参考 `docs/runbook.md#4-move-合约流程` 使用官方 faucet 或内部流程补充测试币。 [Source: docs/runbook.md#4-move-合约流程]
- **Data Models**: BFF 事件监听会将 `orders`、`order_events`、`order_media_assets` 同步到 Postgres，前端 DTO 需匹配这些字段以渲染时间线与统计。 [Source: docs/architecture/4-链下服务与数据流.md#472-数据模型拓展]
- **API Specifications**: 使用 `GET /api/orders/:recordUid`、`GET /api/orders` 与 `/api/media/uploads`；哈希徽章依赖相同 DTO 中的校验结果。 [Source: docs/architecture/4-链下服务与数据流.md#474-api-规划]
- **UX Guidance**: 采用面包屑、费用确认、Explorer 链接等交互，保持与设计系统一致。 [Source: docs/front-end-spec.md#商家创建并支付订单]
- **Technical Constraints**: 强制 BLAKE3 小写哈希、网络一致性，并记录交易 trace 供审计。 [Source: docs/architecture/5-前端体验.md#5-前端体验]
- **File Locations**: 页面放在 `apps/web/app/(merchant)/orders`，特性逻辑在 `apps/web/features/orders`，共享 DTO/配置位于 `packages/shared`。 [Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: 运行 `npm run lint --workspace apps/web` 与 `npm run test --workspace apps/web`，覆盖向导、费用、时间线刷新等场景。 [Source: docs/runbook.md#8-测试策略]

### Testing
- **Framework & Commands**: 采用 Vitest + React Testing Library，并执行 `npm run test --workspace apps/web` 与 lint。 [Source: docs/runbook.md#8-测试策略]
- **Coverage Expectations**: 覆盖成功下单、必填校验、保险费率异常、Gas 模拟失败、拒签、时间线乐观刷新等情境。 [Source: docs/front-end-spec.md#商家创建并支付订单]
- **Utilities & Fixtures**: 模拟钱包适配器、Aptos payload 构造、`/api/orders` 响应，以离线验证所有交互。 [Source: docs/architecture/4-链下服务与数据流.md#473-bff-模块设计]

## Change Log
| Date       | Version | Description      | Author |
| ---------- | ------- | ---------------- | ------ |
| 2025-09-19 | v0.2    | Synced with refreshed architecture contracts and UX flow updates | Bob |
| 2025-09-20 | v0.3    | Clarified optimistic data handling per review feedback | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
