# Story 3.4: Insurance Premium & Payment Validation

## Status
Draft

## Story
**As a** 平台方,
**I want** 动态配置保险费率并在订单创建时校验保费拆解,
**so that** 确保商家支付的保险费用准确无误并可追溯差异化费率。

## Acceptance Criteria
1. 在链上或后端配置保险费率（默认 1%），可按仓库或品类差异化。
2. 订单创建流程读取费率并计算保费，前端展示拆解明细。
3. Move 合约验证实付金额包含仓储费与保费，否则交易失败。
4. 集成测试覆盖不同费率场景下的支付与事件记录。

## Tasks / Subtasks
- [ ] 建立保险费率配置资源与接口 (AC: 1)
  - [ ] 设计保险费率存储与读取逻辑，支持默认费率与按仓库/品类 override，并提供链上/链下配置入口。[Source: docs/epic/epic-3-staking-credit-insurance-claims-质押信用与保险理赔体系.md#story-34-insurance-premium-payment-validation-保险费率与支付校验][Source: docs/prd/2-需求.md#21-功能性需求fr]
  - [ ] 若在链上实现，新增 `haigo::insurance_config` 资源及管理函数；若链下配置，则在 BFF 按运营端可维护的持久层实现配置 API，需在 Runbook 记录操作方式。[Source: docs/runbook.md#3-验证流程]
- [ ] 扩展订单创建流程读取费率并校验 (AC: 2, 3)
  - [ ] 更新 `create_order` 前置流程，从保险费率配置读取当前费率并计算保费，确保 `PricingRecord` 拆解反映最新配置。[Source: docs/architecture/3-链上合约设计.md#3-2-5-费用与支付约束]
  - [ ] 在 `haigo::orders::create_order` 中新增费率与保费校验逻辑，若实付金额不匹配则抛出错误，防止交易金额偏差。[Source: docs/epic/epic-3-staking-credit-insurance-claims-质押信用与保险理赔体系.md#story-34-insurance-premium-payment-validation-保险费率与支付校验]
  - [ ] 识别并处理费率切换时的并发情况（例如提交前后的配置变化），需要在交互层提示重新确认费用。[Source: docs/front-end-spec.md#商家创建并支付订单]
- [ ] 更新前端费用拆解展示 (AC: 2)
  - [ ] 在订单创建向导中读取新的费率配置并实时刷新保费与总价，保持费用确认步骤的 UX 规范。[Source: docs/front-end-spec.md#商家创建并支付订单]
  - [ ] 对于按仓库/品类差异化的费率，明确展示适用范围和来源（默认/自定义），并在网络或配置变化时给出重新计算提示。[Source: docs/front-end-spec.md#design-principles]
  - [ ] 在 `packages/shared` 中同步费用 DTO/常量，确保前端与 BFF 使用一致的费率与货币格式。[Source: docs/architecture/high-level-architecture.md#repository-structure]
- [ ] 扩展 BFF 与共享服务 (AC: 1-3)
  - [ ] 若费率配置在链下维护，新增 `/api/insurance/rates` 相关 REST 接口，提供查询、配置与审计日志，沿用 `{ data, meta }` 格式。[Source: docs/architecture/4-链下服务与数据流.md#4-3-rest-api-已实现]
  - [ ] 将费率变更记录入数据库（仓库/品类、费率、操作者、版本），与订单索引结合以支持差异化分析，并为后续运营监控提供依据。[Source: docs/epic/epic-3-staking-credit-insurance-claims-质押信用与保险理赔体系.md#story-34-insurance-premium-payment-validation-保险费率与支付校验]
  - [ ] 若费率在链上管理，BFF 需提供读取/缓存层并处理事件监听以保证前端数据同步。[Source: docs/architecture/4-链下服务与数据流.md#4-7-roadmap订单与媒体流水线]
- [ ] 增加测试覆盖与运行手册 (AC: 4)
  - [ ] Move 层添加单元测试验证保费校验、费率调整后的交易、异常路径（如费率未配置）。[Source: docs/runbook.md#8-测试策略]
  - [ ] BFF 与前端编写集成测试覆盖费率变更、差异化配置、交易回放与事件记录；运行 `npm run test --workspace apps/bff`、`npm run lint/test --workspace apps/web`。[Source: docs/runbook.md#8-测试策略]
  - [ ] 在 Runbook 中补充费率调整、手动巡检（选择仓库→调整费率→模拟下单→核对时间线）的操作清单。[Source: docs/runbook.md#3-验证流程]

## Dev Notes
- **Previous Story Insights**: Story 2.2 已实现订单费用拆解与保险费率确认；本故事需在其流程基础上接入动态费率与链上校验。[Source: docs/stories/2.2.story.md]
- **Data Models**: 现有数据库未包含保险费率表，需新增配置存储（按仓库/品类/版本），并记录变更时间与操作者以支持审计。[Source: docs/epic/epic-3-staking-credit-insurance-claims-质押信用与保险理赔体系.md#story-34-insurance-premium-payment-validation-保险费率与支付校验]
- **API Specifications**: 新增的保险费率接口应遵循 BFF `{ data, meta }` 模式，并与订单创建 API 集成以返回保费拆解和费率来源说明。[Source: docs/architecture/4-链下服务与数据流.md#4-3-rest-api-已实现]
- **Component Specifications**: 费用确认步骤需展示费率来源与重新计算提示，保持透明可信的设计原则；移动端也需同步更新。[Source: docs/front-end-spec.md#商家创建并支付订单][Source: docs/front-end-spec.md#design-principles]
- **File Locations**: 新增配置模块位于 `apps/bff/src/modules/insurance`，前端逻辑在 `apps/web/features/orders/create`，共享常量在 `packages/shared/src/config`；Move 合约位于 `move/sources/orders.move` 或新 `insurance_config.move`。[Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: 运行 `aptos move test`、`npm run test --workspace apps/bff`、`npm run lint/test --workspace apps/web`，并补充费率变更与交易回放测试满足 NFR7。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]
- **Technical Constraints**: `PricingRecord` 需要持续满足总额等于各项费用之和；费率切换需考虑交易签名前后的配置一致性；部署顺序保持 Registry → Staking → Orders → Insurance 配置的依赖关系。[Source: docs/architecture/3-链上合约设计.md#3-2-5-费用与支付约束][Source: docs/architecture/3-链上合约设计.md#3-2-6-story-对齐清单]

### Testing
- Move 合约测试覆盖保费校验、差异化费率与异常；链下与前端执行 `npm run test --workspace apps/bff`、`npm run lint/test --workspace apps/web`，并编写集成测试模拟费率调整后的下单流程，符合 NFR7 全面测试要求。[Source: docs/runbook.md#8-测试策略][Source: docs/prd/2-需求.md#22-非功能性需求nfr]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-02-21 | v0.1 | 初始草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
