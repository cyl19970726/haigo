# Story 2.1: Order Lifecycle Move Module

## Status
Draft

## Story
**As a** contract developer,
**I want** to implement the on-chain order lifecycle state machine with event emissions and persisted metadata,
**so that** the platform can track every order phase on Aptos with complete fee, logistics, and media hash lineage.

## Acceptance Criteria
1. Define `create_order`, `check_in`, `set_in_storage`, `check_out` entry functions and the underlying state fields for the order lifecycle.
2. Persist storage fee, insurance fee, currency, logistics tracking numbers, timestamps, and media hash metadata for each order transition.
3. Emit `OrderCreated`, `CheckedIn`, `SetInStorage`, and `CheckedOut` events that mirror the stored on-chain data.
4. Provide Move unit tests covering the happy path, invalid state transitions, and role/permission checks across the lifecycle.

## Tasks / Subtasks
- [ ] Scaffold orders module and lifecycle resources (AC: 1, 2)
  - [ ] Create `move/sources/orders.move` publishing module `haigo::orders` with shared constants imported from registry and common utility modules. [Source: docs/architecture/high-level-architecture.md#repository-structure]
  - [ ] Define `OrderBook` resource storing `orders`, `next_order_id`, and optional `timeline_events` vector along with event handles required for state emissions. [Source: docs/architecture/3-链上合约设计.md#状态结构]
  - [ ] Model `Order`, `OrderStatus`, `MediaStage`, `MediaRecord`, and `PricingRecord` so each order captures seller/warehouse addresses, logistics ID, staged media hashes (with category), fee breakdown, timestamps, and last event cursor metadata. [Source: docs/architecture/3-链上合约设计.md#324-媒体存证字段与约束]
- [ ] Implement `create_order` entry flow (AC: 1, 2, 3)
  - [ ] Assert caller roles using `registry::assert_role`, confirm warehouse address is registered, and guard minimum credit via optional `staking::assert_min_credit` hook. [Source: docs/architecture/3-链上合约设计.md#约束与交互]
  - [ ] Allocate incremental order ID, persist full `PricingRecord` (`amount + insurance_fee + platform_fee`), optional initial media payload, and initialize dedupe metadata (`txn_version`, `event_index`, `chain_timestamp`). [Source: docs/architecture/3-链上合约设计.md#325-费用与支付约束]
  - [ ] Transfer `amount + insurance_fee + platform_fee` to the platform account atomically before writing the order, then emit `OrderCreated` with pricing, actors, and any initial media hashes for indexer alignment. [Source: docs/architecture/3-链上合约设计.md#事件载荷]
- [ ] Implement inbound progression (`check_in`, `set_in_storage`) (AC: 1, 2, 3)
  - [ ] Restrict `check_in` to warehouse signers, ensuring state `ORDER_CREATED`, appending `MediaRecord` with `MediaStage::inbound`, validating 32-byte BLAKE3 hashes, and stamping `checked_in_at`. [Source: docs/architecture/3-链上合约设计.md#状态机流程]
  - [ ] Append timeline event entries, emit `CheckedIn`, and persist cursor metadata so off-chain listeners can upsert idempotently. [Source: docs/architecture/4-链下服务与数据流.md#471-事件数据流拓扑]
  - [ ] Enforce `MediaStage` consistency in `set_in_storage`, allow additional storage-specific hashes, update status to `IN_STORAGE`, and emit `SetInStorage`. [Source: docs/architecture/3-链上合约设计.md#324-媒体存证字段与约束]
- [ ] Implement checkout transition (AC: 1, 2, 3)
  - [ ] Allow execution by warehouse operator or delegated platform account, verifying state `IN_STORAGE` and denying when associated insurance claims remain unresolved. [Source: docs/architecture/3-链上合约设计.md#34-insurance-模块]
  - [ ] Record outbound logistics ID, timestamp, and `MediaStage::outbound` hash; update status to `WAREHOUSE_OUT`, emit `CheckedOut`, and mirror data in timeline storage. [Source: docs/architecture/3-链上合约设计.md#状态机流程]
  - [ ] Maintain latest event cursors (`last_txn_version`, `last_event_index`) for ingestion services and ensure `chain_timestamp` is propagated for analytics. [Source: docs/architecture/3-链上合约设计.md#328-与链下协作要点]
- [ ] Expose read APIs and guards
  - [ ] Provide view functions (`get_order_summary`, `get_pricing`, `get_media`) to support BFF/indexer queries without duplicating storage reads, respecting capability restrictions. [Source: docs/architecture/3-链上合约设计.md#328-与链下协作要点]
  - [ ] Centralize transition validation and hash/category checks in internal helpers returning canonical error codes (`E_ROLE_MISMATCH`, `E_MEDIA_STAGE_MISMATCH`, etc.). [Source: docs/architecture/3-链上合约设计.md#327-测试矩阵epic-2]
- [ ] Develop Move unit and property tests (AC: 4)
  - [ ] Cover the full happy path (`create_order → check_in → set_in_storage → check_out`) asserting status transitions, fee debits, timestamps, and emitted events. [Source: docs/runbook.md#8-测试策略]
  - [ ] Add negative suites for duplicate order IDs, invalid roles, skipped states, bad hash lengths, mismatched media stages, and insurance-blocked checkout attempts. [Source: docs/architecture/3-链上合约设计.md#327-测试矩阵epic-2]
  - [ ] Execute `aptos move test` within `move/` ensuring results integrate with CI gating described in the runbook. [Source: docs/runbook.md#4-move-合约流程]
- [ ] Document deployment and integration touchpoints
  - [ ] Update deployment scripts/runbook with module publish steps and ensure resulting addresses propagate to `packages/shared/src/config/aptos.ts` and BFF configuration. [Source: docs/runbook.md#4-move-合约流程]
  - [ ] Share final event payload schema and view function handles with BFF/indexer owners so `/api/orders` timeline projections map to on-chain data. [Source: docs/architecture/4-链下服务与数据流.md#473-bff-模块设计]

## Dev Notes
- **Previous Story Insights**: Story 1.4 did not introduce dependencies, so start fresh while reusing registry helper utilities already validated in Epic 1. [Source: docs/epic/epic-2-order-lifecycle-media-attestation-订单全生命周期与媒体存证.md#story-21-order-lifecycle-move-module]
- **Data Models**: `Order` resources must align with planned Postgres schemas, carrying pricing (amount, insurance_fee, platform_fee), logistics IDs, staged media hashes with categories, timestamps, and ingestion cursors so `orders` / `order_events` / `order_media_assets` can replay the lifecycle. [Source: docs/architecture/4-链下服务与数据流.md#472-数据模型拓展]
- **State Machine & Events**: Ensure strictly ordered transitions `ORDER_CREATED → WAREHOUSE_IN → IN_STORAGE → WAREHOUSE_OUT`, emitting the four lifecycle events with `chain_timestamp` and hash payloads so indexers maintain an authoritative timeline. [Source: docs/architecture/3-链上合约设计.md#326-story-对齐清单]
- **Media Handling**: Use `MediaStage`-aware `MediaRecord` values and enforce 32-byte BLAKE3 hashes; mismatches must raise `E_MEDIA_STAGE_MISMATCH` or `E_INVALID_MEDIA_HASH` to keep chain/off-chain media synchronized. [Source: docs/architecture/3-链上合约设计.md#324-媒体存证字段与约束]
- **Fees & Roles**: Apply `PricingRecord` transfers atomically, honor optional staking credit checks, and integrate insurance claim guards before allowing checkout operations. [Source: docs/architecture/3-链上合约设计.md#325-费用与支付约束]
- **Indexer Expectations**: Capture `txn_version`, `event_index`, and `chain_timestamp` on every transition and expose view functions (`get_pricing`, `get_media`) so the BFF OrdersEventListener can upsert without duplicating logic. [Source: docs/architecture/4-链下服务与数据流.md#471-事件数据流拓扑]
- **Project Structure Notes**: Keep Move sources under `move/sources`, publish addresses through `packages/shared/src/config/aptos.ts`, and document module deployment per runbook guidance. [Source: docs/architecture/high-level-architecture.md#repository-structure]
- **Testing Requirements**: Move tests must execute via `aptos move test`, covering positive lifecycle walks and abort paths (invalid roles, hash errors, insurance blocks) as defined in the Epic 2 testing matrix. [Source: docs/architecture/3-链上合约设计.md#327-测试矩阵epic-2]

### Testing
- **Framework & Commands**: Run `aptos move test` from the `move/` workspace, and include property-style helpers if needed to assert invariants on pricing totals or media vectors. [Source: docs/runbook.md#4-move-合约流程]
- **Coverage Expectations**: Exercise happy-path lifecycle, each error code (`E_ROLE_MISMATCH`, `E_INVALID_STATUS_TRANSITION`, `E_MEDIA_STAGE_MISMATCH`, `E_INVALID_MEDIA_HASH`, `E_INSUFFICIENT_FUNDS`), and insurance-block scenarios to mirror the Epic 2 testing matrix. [Source: docs/architecture/3-链上合约设计.md#327-测试矩阵epic-2]
- **Fixtures & Utilities**: Reuse registry setup helpers plus mock staking/insurance hooks so tests simulate credit thresholds and pending claims before checkout. [Source: docs/architecture/3-链上合约设计.md#34-insurance-模块]

## Change Log
| Date       | Version | Description      | Author |
| ---------- | ------- | ---------------- | ------ |
| 2025-09-19 | v0.2    | Synced with updated architecture references and expanded lifecycle requirements | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
