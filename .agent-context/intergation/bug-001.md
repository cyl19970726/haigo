# Bug-001：BFF 启动时报 Prisma 表不存在（event_cursors）

- 发现时间：2025-09-19
- 模块：apps/bff（NestJS + Prisma）
- 严重级别：中

## 现象与日志

在本地构建并启动 BFF：

```
pnpm --filter @haigo/bff build && pnpm --filter @haigo/bff start
```

控制台日志：

```
prisma:error 
Invalid `prisma.eventCursor.findUnique()` invocation:

The table `public.event_cursors` does not exist in the current database.
...
[Nest] ...  WARN [OrdersEventListener] Orders: failed loading cursor: PrismaClientKnownRequestError: 
Invalid `prisma.eventCursor.findUnique()` invocation:
The table `public.event_cursors` does not exist in the current database.
```

## 影响范围
- 事件监听模块（OrdersEventListener）在 bootstrapCursor() 时从数据库读取游标失败，随后保存游标也会失败。
- 其他接口仍可工作，但订单事件的摄取与增量持久化无法进行。

## 根因分析
- Prisma 模型 `EventCursor` 已在 `apps/bff/prisma/schema.prisma` 定义，并映射为数据库表 `event_cursors`：
  - schema 定义位置：`apps/bff/prisma/schema.prisma:105` 起
  - 映射注解：`@@map("event_cursors")`
- 但当前数据库尚未应用该表的迁移，导致 Prisma 在查询 `event_cursors` 时找不到表。
- 迁移脚本已存在：`apps/bff/prisma/migrations/20250919_add_event_cursors/migration.sql`，未执行。

## 修复方案（本地）
1) 确认环境变量 `DATABASE_URL` 指向正确的 Postgres 实例（开发库）。
2) 执行 Prisma 迁移部署：

```
pnpm --filter @haigo/bff prisma:migrate:deploy
```

等价命令（直接调用 prisma）：

```
cd apps/bff
npx prisma migrate deploy --schema prisma/schema.prisma
```

3) 重新启动 BFF：

```
pnpm --filter @haigo/bff build && pnpm --filter @haigo/bff start
```

4) 观察日志应不再出现 `event_cursors` 表不存在；首次运行会记录或从最新账本开始初始化游标（取决于 `ORDER_INGESTOR_START_FROM_LATEST` 与回填偏移配置）。

## 临时绕过（可选）
- 若暂不希望在本地摄取订单事件，可关闭监听：

```
export ENABLE_ORDER_LISTENER=false
pnpm --filter @haigo/bff start
```

或在 `.env`/配置中设置 `enableOrderListener=false`。

## 验证项
- 日志包含：
  - `Orders: loaded persisted cursor v=... i=...` 或 `Orders: start from latest ledger=`
- 数据库中可见 `event_cursors` 表，且轮询过程中 `last_txn_version/last_event_index` 会更新。

## 预防与持续集成建议
- 在 `apps/bff` 的 CI/CD 启动流程（或本地开发脚本）增加迁移步骤：
  - `pnpm --filter @haigo/bff prisma:migrate:deploy`
- 在 README 或 Runbook 中明确“先迁移再启动”的顺序，避免首次运行落表缺失。
- 可在启动时对 `event_cursors` 执行一次健康检查，记录清晰日志（当前已友好告警，但可在 health/metrics 暴露状态）。

## 备注
- 本问题与前端登录会话 401 无直接关系；401 主要与会话签名/校验相关。此处只影响订单事件的增量摄取与游标持久化。

